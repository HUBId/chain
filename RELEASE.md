# Releasing firewood

Releasing firewood is straightforward and can mostly be done in CI. Updating the
Cargo.toml file is currently manual. Review the companion
[secure release runbook](RELEASES.md) and [security policy](SECURITY.md) for the
CI/CD gates, signing requirements, and advisory coordination expectations that
apply to every tagged release.

## Automated release pipeline

The release workflow defined in [.github/workflows/release.yml](.github/workflows/release.yml) now orchestrates tagging
builds. It executes whenever a SemVer tag (`vMAJOR.MINOR.PATCH`) is pushed or when manually triggered via the
`workflow_dispatch` input. The pipeline reruns formatting, clippy, the full integration test suite, and `cargo audit`
before producing platform-specific artifacts. Optimised binaries for Linux (x86_64 and aarch64) and macOS (x86_64 and
Apple Silicon) are packaged into tarballs for the main `rpp-node` CLI as well as the dedicated runtime entry points
(`node`, `wallet`, `hybrid`, and `validator`). SBOMs, SHA256 manifests, cosign signatures, and provenance attestations are
published alongside the release assets.

### Helper scripts

The workflow calls into helper utilities committed under `scripts/` so that the same steps can be replicated locally:

- `scripts/build_release.sh` – builds and packages the binaries for a given target. It accepts `--target`, `--profile`, and
  `--tool` (either `cargo` or `cross`) flags and emits tarballs under `dist/artifacts/<target>/` together with an optional
  CycloneDX SBOM (`sbom-rpp-node-<target>.json`).
- `scripts/checksums.sh` – generates a sorted SHA256 manifest for a set of artifacts and writes it to the path supplied via
  `--output`.
- `scripts/verify_checksums.sh` – replays the manifest created by `scripts/checksums.sh` to guarantee the recorded hashes.
- `scripts/prepare_changelog.sh` – shells out to `git-cliff` for the requested tag and assembles release notes with required
  sections (features, fixes, breaking changes, security, upgrade notes). The script exits non-zero if the changelog data is
  missing or the tag is not SemVer compliant.
- `scripts/provenance_attest.sh` – emits a SLSA v1 in-toto statement for the artifact, binds the active GitHub workflow as the
  builder, and signs the statement via cosign using GitHub OIDC credentials.

Running the scripts locally mirrors the CI packaging process. For example, to rehearse a Linux aarch64 release package you
can execute:

```bash
cargo install --locked cargo-cyclonedx
./scripts/build_release.sh --target aarch64-unknown-linux-gnu --tool cross
./scripts/checksums.sh --output dist/SHA256SUMS.txt dist/artifacts/aarch64-unknown-linux-gnu/*.tar.gz dist/artifacts/aarch64-unknown-linux-gnu/*.json
./scripts/verify_checksums.sh --manifest dist/SHA256SUMS.txt
```

The release workflow consumes these same outputs, signs every artifact and manifest with cosign, generates provenance via
`scripts/provenance_attest.sh`, and assembles the release notes generated by `scripts/prepare_changelog.sh` into the GitHub
release body.

Firewood is made up of several sub-projects in a workspace. Each project is in
its own crate and has an independent version.

## Git Branch

Start off by crating a new branch:

```console
$ git fetch
$ git switch -c release/v0.0.13 origin/main
branch 'release/v0.0.13' set up to track 'origin/main'.
Switched to a new branch 'release/v0.0.13'
```

## Package Version

Next, update the workspace version and ensure all crates within the firewood
project are using the version of the new release. The root [Cargo.toml](Cargo.toml)
file uses the [`[workspace.package]`](https://doc.rust-lang.org/cargo/reference/workspaces.html#the-package-table)
table to define the version for all subpackages.

```toml
[workspace.package]
version = "0.0.13"
```

Each package inherits this version by setting `package.version.workspace = true`.

```toml
[package]
name = "firewood"
version.workspace = true
```

Therefore, updating only the version defined in the root config is needed.

## Dependency Version

The next step is to bump the dependency declarations to the new version. Packages
within the workspace that are used as libraries are also defined within the
[`[workspace.dependencies]`](https://doc.rust-lang.org/cargo/reference/workspaces.html#the-dependencies-table)
table. E.g.,:

```toml
[workspace.dependencies]
# workspace local packages
firewood = { path = "firewood", version = "0.0.13" }
```

This allows packages within the workspace to inherit the dependency,
including path, version, and workspace-level features by adding `workspace = true`
to the dependency table (note: using `cargo add -p firewood-fwdctl firewood-metrics`
would automatically add the dependency with `workspace = true`).

```toml
[dependencies]
firewood-macros.workspace = true

# more complex example
[target.'cfg(target_os = "linux")'.dependencies]
firewood-storage = { workspace = true, features = ["io-uring"] }

[target.'cfg(not(target_os = "linux"))'.dependencies]
firewood-storage.workspace = true
```

Thefefore, after updating the `workspace.package.version` value, we must update
the dependency versions to match.

## Changelog

To build the changelog, see git-cliff.org. Short version:

```sh
cargo install --locked git-cliff
git cliff --tag v0.0.13 > CHANGELOG.md
```

## Review

> ❗ Be sure to update the versions of all sub-projects before creating a new
> release. Open a PR with the updated versions and merge it before continuing to
> the next step.

## Publish

To trigger a release, push a tag to the main branch matching the new version,

```sh
git tag -s -a v0.0.13 -m 'Release v0.0.13'
git push origin v0.0.13
```

for `v0.0.13` for the merged version change. The CI will automatically publish a
draft release which consists of release notes and changes (see
[.github/workflows/release.yml](.github/workflows/release.yml)).

## Milestone

> NOTE: this should be automated as well.

Close the GitHub milestone for the version that was released. Be sure to create
a new milestone for the next version if one does not already exist. Carry over
any incomplete tasks to the next milestone.
