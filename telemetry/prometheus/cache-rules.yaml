groups:
  - name: cache-efficiency
    interval: 30s
    rules:
      - record: cache:hit_ratio:5m
        expr: |
          sum by (cache) (rate(rpp_runtime_storage_cache_hits[5m]))
            /
          sum by (cache) (rate(rpp_runtime_storage_cache_hits[5m]) + rate(rpp_runtime_storage_cache_misses[5m]))
        labels:
          component: storage

      - record: cache:evictions_per_minute:5m
        expr: sum by (cache) (rate(rpp_runtime_storage_cache_evictions[5m])) * 60
        labels:
          component: storage

      - record: proof_cache:hit_ratio:5m
        expr: |
          sum by (cache) (rate(rpp_runtime_proof_cache_hits[5m]))
            /
          sum by (cache) (rate(rpp_runtime_proof_cache_hits[5m]) + rate(rpp_runtime_proof_cache_misses[5m]))
        labels:
          component: proofs

      - record: proof_cache:evictions_per_minute:5m
        expr: sum by (cache) (rate(rpp_runtime_proof_cache_evictions[5m])) * 60
        labels:
          component: proofs

      - alert: CacheMissSpike
        expr: cache:hit_ratio:5m < 0.7
        for: 10m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "Cache hit ratio dropped below 70% for cache {{ $labels.cache }}"
          description: |
            The cache hit ratio has remained below 70% for 10 minutes.
            Investigate cache sizing, data locality, or backend performance.

      - alert: CacheEvictionSpike
        expr: cache:evictions_per_minute:5m > 50
        for: 10m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "High cache eviction rate for cache {{ $labels.cache }}"
          description: |
            Cache evictions have exceeded 50 per minute for 10 minutes.
            This may indicate memory pressure or poorly tuned retention.

      - alert: ProofCacheThrash
        expr: proof_cache:hit_ratio:5m < 0.5 and proof_cache:evictions_per_minute:5m > 30
        for: 15m
        labels:
          severity: warning
          component: proofs
        annotations:
          summary: "Gossip proof cache hit ratio degraded with elevated evictions"
          description: |
            Proof cache hit ratio stayed below 50% for 15 minutes while evictions
            exceeded 30 per minute. Investigate gossip spam, cache sizing, or
            backend mismatches before hit rates collapse further.

  - name: zk-proof-footprint
    interval: 30s
    rules:
      - record: zk:proof_total_bytes:p90:5m
        expr: |
          histogram_quantile(
            0.90,
            sum by (le, proof_backend, proof_kind) (
              rate(rpp_stark_proof_total_bytes_bucket[5m])
            )
          )
        labels:
          component: proofs

      - alert: ProofSizeRegression
        expr: zk:proof_total_bytes:p90:5m > 1500000
        for: 10m
        labels:
          severity: warning
          component: proofs
        annotations:
          summary: "Proof byte size p90 exceeded 1.5MiB for {{ $labels.proof_backend }} {{ $labels.proof_kind }} proofs"
          description: |
            The 5m p90 of proof byte size is elevated, which may indicate
            compression regressions or unexpected payload growth. Investigate
            recent releases or proof generation configuration before this trend
            saturates network or storage capacity.
