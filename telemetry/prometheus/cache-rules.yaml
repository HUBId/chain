groups:
  - name: cache-efficiency
    interval: 30s
    rules:
      - record: cache:hit_ratio:5m
        expr: |
          sum by (cache) (rate(rpp_runtime_storage_cache_hits[5m]))
            /
          sum by (cache) (rate(rpp_runtime_storage_cache_hits[5m]) + rate(rpp_runtime_storage_cache_misses[5m]))
        labels:
          component: storage

      - record: cache:evictions_per_minute:5m
        expr: sum by (cache) (rate(rpp_runtime_storage_cache_evictions[5m])) * 60
        labels:
          component: storage

      - alert: CacheMissSpike
        expr: cache:hit_ratio:5m < 0.7
        for: 10m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "Cache hit ratio dropped below 70% for cache {{ $labels.cache }}"
          description: |
            The cache hit ratio has remained below 70% for 10 minutes.
            Investigate cache sizing, data locality, or backend performance.

      - alert: CacheEvictionSpike
        expr: cache:evictions_per_minute:5m > 50
        for: 10m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "High cache eviction rate for cache {{ $labels.cache }}"
          description: |
            Cache evictions have exceeded 50 per minute for 10 minutes.
            This may indicate memory pressure or poorly tuned retention.
