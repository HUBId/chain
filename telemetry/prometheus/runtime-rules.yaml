groups:
  - name: consensus-liveness
    interval: 30s
    rules:
      - record: consensus:block_height_delta:5m
        expr: increase(chain_block_height[5m])
        labels:
          component: consensus

      - record: consensus:block_schedule_slots:5m
        expr: increase(consensus_block_schedule_slots_total[5m])
        labels:
          component: consensus

      - record: consensus:block_production_ratio:5m
        expr: |
          increase(chain_block_height[5m])
            / clamp_min(consensus:block_schedule_slots:5m, 1)
        labels:
          component: consensus

        - alert: ConsensusLivenessStall
          expr: consensus:block_height_delta:5m <= 0
          for: 10m
          labels:
            severity: critical
            team: consensus
            sla: liveness
            sla_target: block_progress
          annotations:
            summary: Block production stalled for 10 minutes
            description: >-
              Accepted block height has not advanced for ten minutes. Inspect proposer health,
              peer connectivity, and gossip flow before redirecting traffic to healthy nodes.
          runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#consensus-liveness-and-rpc-availability

        - alert: ConsensusBlockProductionLagWarning
          expr: consensus:block_production_ratio:5m < 0.9
          for: 10m
          labels:
            severity: warning
            team: consensus
            sla: liveness
            sla_target: block_production_rate
          annotations:
            summary: Block production rate below 90% of schedule
            description: >-
              Blocks are being produced at less than 90% of the scheduled slot rate for at least ten minutes.
              Investigate proposer rotation, VRF submissions, and peer connectivity before the gap widens.
          runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#block-production-rate-and-slot-budget

        - alert: ConsensusBlockProductionLagCritical
          expr: consensus:block_production_ratio:5m < 0.75
          for: 10m
          labels:
            severity: critical
            team: consensus
            sla: liveness
            sla_target: block_production_rate
          annotations:
            summary: Block production rate below 75% of schedule
            description: >-
              Blocks are being produced at less than 75% of the scheduled slot rate for at least ten minutes. Page the on-call
              and execute the consensus liveness runbook to restore proposer health before finality stalls.
          runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#block-production-rate-and-slot-budget

  - name: rpc-availability
    interval: 30s
    rules:
      - record: rpc:availability_ratio:5m
        expr: |
          sum(rate(rpp_runtime_rpc_request_total{result="success"}[5m]))
            /
          clamp_min(sum(rate(rpp_runtime_rpc_request_total[5m])), 0.0001)
        labels:
          component: rpc

      - alert: RpcAvailabilityDegradedWarning
        expr: rpc:availability_ratio:5m < 0.99
        for: 5m
        labels:
          severity: warning
          team: rpc
          sla: availability
          sla_target: rpc_success_ratio
        annotations:
          summary: RPC availability dipped below 99%
          description: >-
            RPC responses have fallen below the 99% success target for five minutes. Check ingress,
            recent deploys, and node health before the outage widens.
          runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#consensus-liveness-and-rpc-availability

      - alert: RpcAvailabilityDegradedCritical
        expr: rpc:availability_ratio:5m < 0.95
        for: 10m
        labels:
          severity: critical
          team: rpc
          sla: availability
          sla_target: rpc_success_ratio
        annotations:
          summary: RPC availability below 95% for 10 minutes
          description: >-
            RPC endpoints have been failing more than 5% of requests for ten minutes. Page the on-call,
            validate node readiness, and consider draining traffic while recovering the API layer.
          runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#consensus-liveness-and-rpc-availability
