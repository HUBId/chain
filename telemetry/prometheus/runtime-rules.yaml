groups:
  - name: consensus-liveness
    interval: 30s
    rules:
      - record: consensus:block_height_delta:5m
        expr: sum by (environment) (increase(chain_block_height[5m]))
        labels:
          component: consensus

      - record: consensus:block_schedule_slots:5m
        expr: sum by (environment) (increase(consensus_block_schedule_slots_total[5m]))
        labels:
          component: consensus

      - record: consensus:block_production_ratio:5m
        expr: |
          consensus:block_height_delta:5m
            / clamp_min(consensus:block_schedule_slots:5m, 1)
        labels:
          component: consensus

      - alert: ConsensusLivenessStall
        expr: consensus:block_height_delta:5m <= 0
        for: 10m
        labels:
          severity: critical
          team: consensus
          sla: liveness
          sla_target: block_progress
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Block production stalled for 10 minutes
          description: >-
            Accepted block height has not advanced for ten minutes. Inspect proposer health,
            peer connectivity, and gossip flow before redirecting traffic to healthy nodes.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#consensus-liveness-and-rpc-availability

      - alert: ConsensusBlockProductionLagWarning
        expr: consensus:block_production_ratio:5m < 0.9
        for: 10m
        labels:
          severity: warning
          team: consensus
          sla: liveness
          sla_target: block_production_rate
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Block production rate below 90% of schedule
          description: >-
            Blocks are being produced at less than 90% of the scheduled slot rate for at least ten minutes.
            Investigate proposer rotation, VRF submissions, and peer connectivity before the gap widens.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#block-production-rate-and-slot-budget

      - alert: ConsensusBlockProductionLagCritical
        expr: consensus:block_production_ratio:5m < 0.75
        for: 10m
        labels:
          severity: critical
          team: consensus
          sla: liveness
          sla_target: block_production_rate
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Block production rate below 75% of schedule
          description: >-
            Blocks are being produced at less than 75% of the scheduled slot rate for at least ten minutes. Page the on-call
            and execute the consensus liveness runbook to restore proposer health before finality stalls.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#block-production-rate-and-slot-budget

  - name: rpc-availability
    interval: 30s
    rules:
      - record: rpc:availability_ratio:5m
        expr: |
          sum by (environment) (rate(rpp_runtime_rpc_request_total{result="success"}[5m]))
            /
          clamp_min(sum by (environment) (rate(rpp_runtime_rpc_request_total[5m])), 0.0001)
        labels:
          component: rpc

      - alert: RpcAvailabilityDegradedWarning
        expr: rpc:availability_ratio:5m < 0.99
        for: 5m
        labels:
          severity: warning
          team: rpc
          sla: availability
          sla_target: rpc_success_ratio
          environment: "{{ $labels.environment }}"
        annotations:
          summary: RPC availability dipped below 99%
          description: >-
            RPC responses have fallen below the 99% success target for five minutes. Check ingress,
            recent deploys, and node health before the outage widens.
          runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#consensus-liveness-and-rpc-availability

      - alert: RpcAvailabilityDegradedCritical
        expr: rpc:availability_ratio:5m < 0.95
        for: 10m
        labels:
          severity: critical
          team: rpc
          sla: availability
          sla_target: rpc_success_ratio
          environment: "{{ $labels.environment }}"
        annotations:
          summary: RPC availability below 95% for 10 minutes
          description: >-
            RPC endpoints have been failing more than 5% of requests for ten minutes. Page the on-call,
            validate node readiness, and consider draining traffic while recovering the API layer.
          runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#consensus-liveness-and-rpc-availability

  - name: uptime-baselines
    interval: 1m
    rules:
      - record: uptime:participation_ratio:30d_p50
        expr: quantile_over_time(0.5, uptime_participation_ratio[30d])
        labels:
          component: uptime

      - record: uptime:observation_gap_seconds:30d_p90
        expr: quantile_over_time(0.9, uptime_observation_age_seconds[30d])
        labels:
          component: uptime

      - record: timetoke:epoch_age_seconds:30d_p90
        expr: quantile_over_time(0.9, timetoke_epoch_age_seconds[30d])
        labels:
          component: reputation

      - record: timetoke:accrual_rate_per_second:30d_p50
        expr: quantile_over_time(0.5, rate(timetoke_accrual_hours_total[15m]))
        labels:
          component: reputation

  - name: uptime-reputation
    interval: 30s
    rules:
      - alert: UptimeParticipationDropWarning
        expr: |
          uptime_participation_ratio
            < clamp_min(
                uptime:participation_ratio:30d_p50 - 0.023,
                0.97
              )
        for: 10m
        labels:
          severity: warning
          team: uptime
          sla: uptime
          sla_target: uptime_participation
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Uptime participation dipped below the warning ratio
          description: >-
            Active validator participation fell beneath the documented baseline with buffer for at least ten minutes.
            Correlate with recent node joins/removals and confirm new validators are producing uptime proofs.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: UptimeParticipationDropCritical
        expr: |
          uptime_participation_ratio
            < clamp_min(
                uptime:participation_ratio:30d_p50 - 0.053,
                0.94
              )
        for: 10m
        labels:
          severity: critical
          team: uptime
          sla: uptime
          sla_target: uptime_participation
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Uptime participation breached the critical ratio
          description: >-
            Validator participation in uptime proofs fell below the buffered baseline. Investigate churn, peer counts,
            and scheduler health to restore coverage before timetoke accrual stalls.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: UptimeObservationGapWarning
        expr: |
          max_over_time(uptime_observation_age_seconds[5m])
            > clamp_min(
                uptime:observation_gap_seconds:30d_p90 + 600,
                900
              )
        for: 10m
        labels:
          severity: warning
          team: uptime
          sla: uptime
          sla_target: uptime_observation_gap
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Uptime proofs missing beyond the warning gap
          description: >-
            The latest uptime proof age exceeded the historical baseline plus buffer. Verify schedulers are running after
            node joins and that gossiped observations reach the reputation manager.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

  - name: wallet-prover-health
    interval: 30s
    rules:
      - record: wallet:prover_queue_depth:max:10m
        expr: max_over_time(wallet_prover_queue_depth[10m])
        labels:
          component: wallet

      - record: wallet:prover_job_latency:p95_seconds:10m
        expr: |
          histogram_quantile(
            0.95,
            sum(rate(rpp_runtime_wallet_prover_job_duration_ms_bucket[10m])) by (le, backend, environment)
          ) / 1000
        labels:
          component: wallet

      - alert: UptimeObservationGapCritical
        expr: |
          max_over_time(uptime_observation_age_seconds[5m])
            > clamp_min(
                uptime:observation_gap_seconds:30d_p90 + 1500,
                1800
              )
        for: 10m
        labels:
          severity: critical
          team: uptime
          sla: uptime
          sla_target: uptime_observation_gap
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Uptime proofs missing beyond the critical gap
          description: >-
            No uptime proofs landed for thirty minutes. Page the on-call to restart schedulers, reseed peers, or remove
            faulty validators before timetoke balances decay.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: TimetokeEpochDelayWarning
        expr: |
          max_over_time(timetoke_epoch_age_seconds[10m])
            > clamp_min(
                timetoke:epoch_age_seconds:30d_p90 + 1800,
                3600
              )
        for: 10m
        labels:
          severity: warning
          team: reputation
          sla: uptime
          sla_target: timetoke_epoch_delay
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Timetoke epoch rollover delayed
          description: >-
            Timetoke epochs have not rolled over within the buffered historical window. Validators may not accrue uptime
            credit; inspect timetoke schedulers and recent proposer elections before the delay widens.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: TimetokeEpochDelayCritical
        expr: |
          max_over_time(timetoke_epoch_age_seconds[10m])
            > clamp_min(
                timetoke:epoch_age_seconds:30d_p90 + 3600,
                5400
              )
        for: 10m
        labels:
          severity: critical
          team: reputation
          sla: uptime
          sla_target: timetoke_epoch_delay
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Timetoke epoch rollover critically delayed
          description: >-
            Timetoke epochs have stalled for more than the buffered baseline. Pause proposer changes and recover the timetoke
            scheduler before resuming normal block production.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: TimetokeAccrualStallWarning
        expr: |
          rate(timetoke_accrual_hours_total[15m])
            < clamp_min(
                timetoke:accrual_rate_per_second:30d_p50 - 0.0003,
                0.00025
              )
        for: 15m
        labels:
          severity: warning
          team: reputation
          sla: uptime
          sla_target: timetoke_accrual_rate
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Timetoke accrual slowed below the warning rate
          description: >-
            Timetoke credit accrual dipped under the buffered historical rate after validator churn. Inspect the uptime scheduler,
            timetoke sync, and recent node removals before balances decay.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: TimetokeAccrualStallCritical
        expr: |
          rate(timetoke_accrual_hours_total[15m])
            < clamp_min(
                timetoke:accrual_rate_per_second:30d_p50 - 0.0003,
                0.00025
              )
        for: 30m
        labels:
          severity: critical
          team: reputation
          sla: uptime
          sla_target: timetoke_accrual_rate
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Timetoke accrual stalled after validator churn
          description: >-
            Timetoke credits stopped increasing for more than thirty minutes. Pause additional removals, restart uptime pipelines,
            and replay missing proofs before the decay cycle slashes healthy operators.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts
