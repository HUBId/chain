prometheus:
  prometheusSpec:
    additionalScrapeConfigs: |
      - job_name: rpp-node
        metrics_path: /metrics
        static_configs:
          - targets: ["rpp-node.default.svc.cluster.local:9797"]
        # Uncomment to enable auth if rollout.telemetry.metrics.auth_token is set:
        # authorization:
        #   credentials: Bearer change-me
      - job_name: otlp-collector
        metrics_path: /metrics
        static_configs:
          - targets: ["telemetry-collector-opentelemetry-collector.default.svc.cluster.local:9464"]

  additionalPrometheusRulesMap:
    cache-efficiency:
      groups:
        - name: cache-efficiency
          rules:
            - record: cache:hit_ratio:5m
              expr: |
                sum by (cache) (rate(rpp_runtime_storage_cache_hits[5m]))
                  /
                sum by (cache) (rate(rpp_runtime_storage_cache_hits[5m]) + rate(rpp_runtime_storage_cache_misses[5m]))
              labels:
                component: storage

            - record: cache:evictions_per_minute:5m
              expr: sum by (cache) (rate(rpp_runtime_storage_cache_evictions[5m])) * 60
              labels:
                component: storage

            - record: proof_cache:hit_ratio:5m
              expr: |
                sum by (cache) (rate(rpp_runtime_proof_cache_hits[5m]))
                  /
                sum by (cache) (rate(rpp_runtime_proof_cache_hits[5m]) + rate(rpp_runtime_proof_cache_misses[5m]))
              labels:
                component: proofs

            - record: proof_cache:evictions_per_minute:5m
              expr: sum by (cache) (rate(rpp_runtime_proof_cache_evictions[5m])) * 60
              labels:
                component: proofs

            - alert: CacheMissSpike
              expr: cache:hit_ratio:5m < 0.7
              for: 10m
              labels:
                severity: warning
                component: storage
              annotations:
                summary: "Cache hit ratio dropped below 70% for cache {{ $labels.cache }}"
                description: |
                  The cache hit ratio has remained below 70% for 10 minutes.
                  Investigate cache sizing, data locality, or backend performance.

            - alert: CacheEvictionSpike
              expr: cache:evictions_per_minute:5m > 50
              for: 10m
              labels:
                severity: warning
                component: storage
              annotations:
                summary: "High cache eviction rate for cache {{ $labels.cache }}"
                description: |
                  Cache evictions have exceeded 50 per minute for 10 minutes.
                  This may indicate memory pressure or poorly tuned retention.

            - alert: ProofCacheThrash
              expr: proof_cache:hit_ratio:5m < 0.5 and proof_cache:evictions_per_minute:5m > 30
              for: 15m
              labels:
                severity: warning
                component: proofs
              annotations:
                summary: "Gossip proof cache hit ratio degraded with elevated evictions"
                description: |
                  Proof cache hit ratio stayed below 50% for 15 minutes while evictions
                  exceeded 30 per minute. Investigate gossip spam, cache sizing, or
                  backend mismatches before hit rates collapse further.

  serviceAccount:
    create: true

  podSecurityContext:
    fsGroup: 65534

  securityContext:
    runAsNonRoot: true

nodeExporter:
  enabled: false
kubeStateMetrics:
  enabled: false
alertmanager:
  enabled: false

# Provision a default Prometheus datasource for Grafana.
grafana:
  adminPassword: admin
  additionalDataSources:
    - name: rpp-prometheus
      type: prometheus
      access: proxy
      url: http://telemetry-prometheus-kube-prometheus-prometheus:9090
      isDefault: true
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: cache-efficiency
          orgId: 1
          folder: Storage
          type: file
          disableDeletion: false
          updateIntervalSeconds: 30
          options:
            path: /var/lib/grafana/dashboards/cache-efficiency
  dashboards:
    cache-efficiency:
      cache-efficiency.json: |-
        {
          "uid": "cache-efficiency",
          "title": "Cache Efficiency",
          "timezone": "browser",
          "schemaVersion": 39,
          "version": 1,
          "refresh": "30s",
          "panels": [
            {
              "type": "timeseries",
              "title": "Cache Hit Ratio (5m)",
              "gridPos": { "h": 8, "w": 24, "x": 0, "y": 0 },
              "targets": [
                {
                  "expr": "cache:hit_ratio:5m",
                  "legendFormat": "{{cache}}",
                  "refId": "A"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "unit": "percentunit",
                  "min": 0,
                  "max": 1,
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      { "color": "red", "value": null },
                      { "color": "semi-dark-orange", "value": 0.7 },
                      { "color": "green", "value": 0.9 }
                    ]
                  }
                },
                "overrides": []
              },
              "options": {
                "legend": { "displayMode": "list", "placement": "bottom" },
                "tooltip": { "mode": "single" }
              }
            },
            {
              "type": "timeseries",
              "title": "Cache Request Rate (5m)",
              "gridPos": { "h": 8, "w": 24, "x": 0, "y": 8 },
              "targets": [
                {
                  "expr": "sum by (cache) (rate(rpp_runtime_storage_cache_hits[5m]))",
                  "legendFormat": "Hits - {{cache}}",
                  "refId": "A"
                },
                {
                  "expr": "sum by (cache) (rate(rpp_runtime_storage_cache_misses[5m]))",
                  "legendFormat": "Misses - {{cache}}",
                  "refId": "B"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "unit": "reqps"
                },
                "overrides": []
              },
              "options": {
                "legend": { "displayMode": "table", "placement": "bottom" },
                "tooltip": { "mode": "multi" }
              }
            },
            {
              "type": "timeseries",
              "title": "Cache Evictions per Minute (5m)",
              "gridPos": { "h": 8, "w": 24, "x": 0, "y": 16 },
              "targets": [
                {
                  "expr": "cache:evictions_per_minute:5m",
                  "legendFormat": "{{cache}}",
                  "refId": "A"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "unit": "evictions/min"
                },
                "overrides": []
              },
              "options": {
                "legend": { "displayMode": "list", "placement": "bottom" },
                "tooltip": { "mode": "single" }
              }
            },
            {
              "type": "timeseries",
              "title": "Proof Cache Hit Ratio (5m)",
              "gridPos": { "h": 8, "w": 24, "x": 0, "y": 24 },
              "targets": [
                {
                  "expr": "proof_cache:hit_ratio:5m",
                  "legendFormat": "{{cache}}",
                  "refId": "A"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "unit": "percentunit",
                  "min": 0,
                  "max": 1,
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      { "color": "red", "value": null },
                      { "color": "semi-dark-orange", "value": 0.5 },
                      { "color": "green", "value": 0.85 }
                    ]
                  }
                },
                "overrides": []
              },
              "options": {
                "legend": { "displayMode": "list", "placement": "bottom" },
                "tooltip": { "mode": "single" }
              }
            },
            {
              "type": "timeseries",
              "title": "Proof Cache Evictions per Minute (5m)",
              "gridPos": { "h": 8, "w": 24, "x": 0, "y": 32 },
              "targets": [
                {
                  "expr": "proof_cache:evictions_per_minute:5m",
                  "legendFormat": "{{cache}}",
                  "refId": "A"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "unit": "evictions/min"
                },
                "overrides": []
              },
              "options": {
                "legend": { "displayMode": "list", "placement": "bottom" },
                "tooltip": { "mode": "single" }
              }
            }
          ],
          "templating": { "list": [] }
        }
