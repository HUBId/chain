# Firewood threat model

This document summarises the primary assets, trust boundaries, controls, and
residual risks for Firewood deployments. It complements the operational runbooks
in [`docs/`](./) and links to component-specific hardening guides.

## Assets and trust zones

- **Runtime state and storage.** The node runtime persists Merkle trie revisions
  and pruning metadata on disk; compromising the process or its data directories
  leaks consensus-critical state and enables history tampering attempts.
- **Secrets and key material.** Validator nodes load VRF keys from the configured
  secrets backend, which may be the local filesystem or a remote service such as
  Vault. The runtime exposes helpers to rotate and inspect this material through
  `rpp-node validator vrf` subcommands.【F:rpp/node/src/main.rs†L29-L115】【F:rpp/node/src/main.rs†L146-L199】
- **RPC and telemetry surfaces.** The Axum-based RPC server multiplexes
  operational, wallet, consensus, and telemetry endpoints and supports optional
  bearer-token authentication and request rate limiting.【F:rpp/rpc/api.rs†L195-L256】【F:rpp/rpc/api.rs†L960-L1047】
- **Rollout and feature-gate controls.** Runtime modes (`node`, `wallet`,
  `hybrid`, `validator`) enable different component sets and telemetry defaults,
  and may be switched via CLI flags or config precedence.【F:rpp/node/src/main.rs†L26-L115】【F:rpp/node/src/lib.rs†L143-L216】

## Entry points and attack surfaces

| Surface | Description | Controls |
| --- | --- | --- |
| CLI (`rpp-node`) | Manages runtime startup, dry runs, config generation, and validator tooling. | Clap-enforced parsing, explicit exit codes, and secrets backend validation ensure misconfiguration fails closed.【F:rpp/node/src/main.rs†L16-L114】【F:rpp/runtime/config.rs†L36-L177】 |
| RPC API | Hosts health checks, consensus operations, wallet helpers, proof submission, and rollout governance endpoints. | Optional bearer tokens, configurable CORS allow-list, and per-minute request rate limiting enforced by middleware.【F:rpp/rpc/api.rs†L400-L520】【F:rpp/rpc/api.rs†L960-L1047】 |
| Telemetry exporters | OTLP and metrics exporters send runtime/validator telemetry to collectors. | Disabled unless configured; CLI flags can override endpoint, auth token, and sampling interval per run.【F:rpp/node/src/lib.rs†L143-L216】【F:rpp/runtime/config.rs†L894-L912】 |
| Secrets backend | Filesystem paths or Vault identifiers backing VRF keys. | Backend-specific validation rejects empty identifiers and ensures directories exist before use.【F:rpp/runtime/config.rs†L36-L177】 |

## Defensive controls

1. **Configuration validation.** The runtime validates configuration files and
   feature gates before startup, halting the process when mandatory telemetry or
   secrets settings are invalid.【F:rpp/node/src/lib.rs†L993-L1080】【F:rpp/runtime/config.rs†L915-L1076】
2. **Authentication and rate limiting.** RPC requests require bearer tokens when
   configured and can be throttled globally per minute to mitigate abuse.【F:rpp/rpc/api.rs†L400-L520】【F:rpp/rpc/api.rs†L960-L1047】
3. **Telemetry integrity.** Telemetry exporters announce degraded states via
   structured logs when endpoints are missing or backpressure occurs, helping
   operators detect data loss quickly.【F:rpp/runtime/telemetry/exporter.rs†L68-L133】【F:rpp/runtime/telemetry/metrics.rs†L31-L70】
4. **Release provenance.** Signed release artifacts, SBOMs, and provenance
   attestations generated by the hardened CI pipeline ensure supply-chain
   integrity when paired with `cosign` verification.【F:SECURITY.md†L16-L40】【F:scripts/build_release.sh†L27-L147】

## Residual risks and mitigations

- **Local privilege escalation.** Filesystem-backed secrets inherit the
  permissions of the host OS. Enforce strict ownership (`600`/`700`) on
  key directories and prefer Vault integrations in multi-tenant settings.
- **Token leakage.** RPC and telemetry bearer tokens configured via CLI flags or
  environment variables may surface in shell history. Use process managers with
  secret redaction and rotate tokens regularly.【F:rpp/node/src/lib.rs†L143-L216】【F:config/validator.toml†L1-L70】
- **Unsupported HSMs.** The HSM backend is not available in current builds; if
  hardware-backed keys are mandatory, wrap the Vault backend with an HSM-backed
  secret store and restrict runtime access.【F:rpp/runtime/config.rs†L58-L177】
- **Third-party dependencies.** Vendors such as Electrs telemetry are gated by
  feature flags; audit those crates separately and keep `vendor_electrs`
  disabled unless necessary.【F:docs/vendor/electrs-metrics.md†L4-L26】

Refer to [`KEY_MANAGEMENT.md`](KEY_MANAGEMENT.md) for lifecycle procedures,
[`API_SECURITY.md`](API_SECURITY.md) for endpoint hardening, and
[`GOVERNANCE.md`](GOVERNANCE.md) for release and change-control policies.
