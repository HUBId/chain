# Firewood FFI testing

The Go bindings around the Firewood storage engine expose higher-level helpers for
creating and verifying range proofs. The end-to-end tests in
[`ffi/proofs_test.go`](../../ffi/proofs_test.go) now drive the exported
verification routine on every happy-path scenario. Each test ensures that:

- `(*ffi.Database).VerifyRangeProof` accepts proofs generated by the same
  database configuration.
- Successful verification leaves the database root hash untouched so the
  caller can assert it still matches the expected revision.
- Tampering with the serialized proof bytes results in a verification error
  instead of silently succeeding.

The tampering checks deserialize mutated proof bytes with `RangeProof.UnmarshalBinary`
and expect `VerifyRangeProof` to surface the failure without modifying the
underlying store state. This provides coverage that the Go FFI forwards
validation failures coming from the Rust verifier.

## Panic reporting over FFI

Rust panics that cross the FFI boundary now include a captured backtrace in
their error payload. The shared panic hook serializes the panic message
followed by the formatted backtrace so Go callers see the same context that a
Rust caller would. Consumers that need to log the panic from Rust can decode
the UTF-8 payload with `firewood::value::panic_error_to_str`.

The Rust unit tests in `ffi/src/value/results.rs` and the Go integration test
`TestFFIPanicIncludesBacktrace` cover this behaviour by triggering a controlled
panic and asserting that both the panic message and `Backtrace:` marker are
present in the resulting error string.

## Running the Go FFI tests locally

To exercise the Go bindings end-to-end you must first build the Firewood FFI
static library and then run `go test` inside the `ffi` module.

```bash
cargo build -p firewood-ffi --locked
(cd ffi && go test ./...)
```

You can repeat the same steps with optional workspace features enabled. For
example, the STARK backend coverage exercised in CI can be reproduced with:

```bash
cargo build -p firewood-ffi --locked --features backend-rpp-stark
(cd ffi && go test ./...)
```

## Continuous integration

The `firewood-ffi-go` job inside `.github/workflows/ci.yml` runs the Go test
suite in a two-entry feature matrix:

- The default configuration (`cargo build -p firewood-ffi --locked`).
- The STARK backend (`cargo build -p firewood-ffi --locked --features backend-rpp-stark`).

Each matrix entry builds the static library with the requested feature set and
then executes `go test ./...` from the `ffi` directory. This guarantees that the
Go verification bindings pass with both the default and STARK-enabled Rust
configurations before changes merge.
