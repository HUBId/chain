name: Nightly simulation freshness gate

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

permissions:
  actions: read
  contents: read
  pull-requests: read

env:
  FRESHNESS_HOURS: '24'

jobs:
  nightly-slo-gate:
    name: Nightly Simulation Freshness
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate latest nightly run
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const { owner, repo } = context.repo;
            const defaultBranch = context.payload.repository?.default_branch ?? process.env.GITHUB_BASE_REF ?? 'main';

            const { data } = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: 'nightly.yml',
              branch: defaultBranch,
              per_page: 20,
              status: 'completed'
            });

            const runs = data.workflow_runs ?? [];
            const latestRun = runs[0];
            const latestSuccess = runs.find((run) => run.conclusion === 'success');
            const freshnessHours = Number(process.env.FRESHNESS_HOURS || '24');
            const now = new Date();

            let summaryLines = [];
            let conclusion = 'failure';
            let shortMessage = '';

            summaryLines.push('| Field | Value |');
            summaryLines.push('| --- | --- |');

            if (!latestRun) {
              shortMessage = 'No completed nightly runs were found for the default branch.';
              summaryLines.push(`| Latest run | missing |`);
            } else {
              const latestCompletedAtRaw = latestRun.updated_at ?? latestRun.run_started_at;
              const latestCompletedAt = new Date(latestCompletedAtRaw);
              const latestAgeHours = (now.getTime() - latestCompletedAt.getTime()) / (1000 * 60 * 60);
              const latestAgeDisplay = latestAgeHours.toFixed(1);
              const latestConclusion = latestRun.conclusion ?? latestRun.status;
              summaryLines.push(`| Latest run | [${latestConclusion}](${latestRun.html_url}) (${latestAgeDisplay}h old) |`);
            }

            if (!latestSuccess) {
              summaryLines.push(`| Most recent success | not found |`);
              shortMessage = 'No successful nightly runs were found on the default branch.';
            } else {
              const successCompletedAtRaw = latestSuccess.updated_at ?? latestSuccess.run_started_at;
              const successCompletedAt = new Date(successCompletedAtRaw);
              const successAgeHours = (now.getTime() - successCompletedAt.getTime()) / (1000 * 60 * 60);
              const successAgeDisplay = successAgeHours.toFixed(1);
              summaryLines.push(
                `| Most recent success | [run #${latestSuccess.run_number}](${latestSuccess.html_url}) (${successAgeDisplay}h old) |`
              );

              if (successAgeHours <= freshnessHours) {
                conclusion = 'success';
                const latestConclusion = latestRun
                  ? latestRun.conclusion ?? latestRun.status
                  : 'unknown';
                shortMessage = `Nightly run is healthy (most recent success ${successAgeDisplay}h old; latest run conclusion: ${latestConclusion}).`;
              } else {
                shortMessage = `Most recent successful nightly run is ${successAgeDisplay}h old which exceeds the ${freshnessHours}h freshness target.`;
              }
            }

            if (process.env.GITHUB_STEP_SUMMARY) {
              summaryLines.unshift(`# Nightly simulation freshness`);
              summaryLines.push('');
              await fs.promises.appendFile(process.env.GITHUB_STEP_SUMMARY, summaryLines.join('\n'));
            }

            if (conclusion !== 'success') {
              core.setFailed(shortMessage);
            } else {
              core.info(shortMessage);
            }
