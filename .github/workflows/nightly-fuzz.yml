name: Nightly fuzzing

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      NIGHTLY_TOOLCHAIN: nightly-2025-07-14
      FUZZ_FAILURES: ${{ github.workspace }}/ci-artifacts/fuzz-failures
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare fuzz artifact directories
        run: |
          mkdir -p "$FUZZ_FAILURES/p2p" "$FUZZ_FAILURES/wallet" "$FUZZ_FAILURES/prover"

      - name: Install nightly toolchain
        run: rustup toolchain install "$NIGHTLY_TOOLCHAIN" --profile minimal

      - name: Install cargo-fuzz
        run: cargo +"$NIGHTLY_TOOLCHAIN" install cargo-fuzz --locked

      - name: Run P2P fuzzers
        working-directory: rpp/p2p
        run: |
          cargo +"$NIGHTLY_TOOLCHAIN" fuzz run handle_meta -- -seed=0x5A17F00D -max_total_time=120 -timeout=5 -artifact_prefix="$FUZZ_FAILURES/p2p/handle_meta-" -exact_artifact_path="$FUZZ_FAILURES/p2p/handle_meta-minimized"
          cargo +"$NIGHTLY_TOOLCHAIN" fuzz run handle_blocks -- -seed=0x5A17F00D -max_total_time=120 -timeout=5 -artifact_prefix="$FUZZ_FAILURES/p2p/handle_blocks-" -exact_artifact_path="$FUZZ_FAILURES/p2p/handle_blocks-minimized"
          cargo +"$NIGHTLY_TOOLCHAIN" fuzz run handle_votes -- -seed=0x5A17F00D -max_total_time=120 -timeout=5 -artifact_prefix="$FUZZ_FAILURES/p2p/handle_votes-" -exact_artifact_path="$FUZZ_FAILURES/p2p/handle_votes-minimized"
          cargo +"$NIGHTLY_TOOLCHAIN" fuzz run admission_evaluate_publish -- -seed=0x5A17F00D -max_total_time=120 -timeout=5 -artifact_prefix="$FUZZ_FAILURES/p2p/admission_evaluate_publish-" -exact_artifact_path="$FUZZ_FAILURES/p2p/admission_evaluate_publish-minimized"

      - name: Run wallet fuzzers
        working-directory: rpp/wallet
        run: |
          cargo +"$NIGHTLY_TOOLCHAIN" fuzz run wallet_rpc -- -seed=0x5A17F00D -max_total_time=120 -timeout=5 -artifact_prefix="$FUZZ_FAILURES/wallet/wallet_rpc-" -exact_artifact_path="$FUZZ_FAILURES/wallet/wallet_rpc-minimized"
          cargo +"$NIGHTLY_TOOLCHAIN" fuzz run zsi_lifecycle -- -seed=0x5A17F00D -max_total_time=120 -timeout=5 -artifact_prefix="$FUZZ_FAILURES/wallet/zsi_lifecycle-" -exact_artifact_path="$FUZZ_FAILURES/wallet/zsi_lifecycle-minimized"

      - name: Run prover fuzzers
        working-directory: prover/fuzz
        run: |
          cargo +"$NIGHTLY_TOOLCHAIN" fuzz run stwo_circuit_loader -- -seed=0x5A17F00D -max_total_time=120 -timeout=5 -artifact_prefix="$FUZZ_FAILURES/prover/stwo_circuit_loader-" -exact_artifact_path="$FUZZ_FAILURES/prover/stwo_circuit_loader-minimized"

      - name: Package corpora
        run: |
          mkdir -p ci-artifacts/fuzz-corpora
          rm -rf ci-artifacts/fuzz-corpora/*
          mkdir -p ci-artifacts/fuzz-corpora/p2p ci-artifacts/fuzz-corpora/wallet ci-artifacts/fuzz-corpora/prover
          cp -a rpp/p2p/fuzz/corpus ci-artifacts/fuzz-corpora/p2p/
          cp -a rpp/wallet/fuzz/corpus ci-artifacts/fuzz-corpora/wallet/
          cp -a prover/fuzz/corpus ci-artifacts/fuzz-corpora/prover/
          tar -czf ci-artifacts/nightly-fuzz-corpus.tar.gz -C ci-artifacts fuzz-corpora

      - name: Upload corpora
        uses: actions/upload-artifact@v4
        with:
          name: nightly-fuzz-corpus
          path: ci-artifacts/nightly-fuzz-corpus.tar.gz

      - name: Package failing corpora
        if: failure()
        run: tar -czf ci-artifacts/nightly-fuzz-failures.tar.gz -C ci-artifacts fuzz-failures

      - name: Upload failing corpora
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-fuzz-failures
          path: ci-artifacts/nightly-fuzz-failures.tar.gz

  fuzz-backend-rpp-stark:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      NIGHTLY_TOOLCHAIN: nightly-2025-07-14
      RPP_FUZZ_SEED: 0x5A17F00D
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install nightly toolchain
        run: rustup toolchain install "$NIGHTLY_TOOLCHAIN" --profile minimal

      - name: Install cargo-fuzz
        run: cargo +"$NIGHTLY_TOOLCHAIN" install cargo-fuzz --locked

      - name: Run backend-rpp-stark P2P fuzz build
        working-directory: rpp/p2p
        run: cargo +"$NIGHTLY_TOOLCHAIN" fuzz run handle_meta --features backend-rpp-stark -- -seed="$RPP_FUZZ_SEED" -runs=32 -timeout=5

      - name: Run backend-rpp-stark wallet fuzz build
        working-directory: rpp/wallet
        run: cargo +"$NIGHTLY_TOOLCHAIN" fuzz run wallet_rpc --features backend-rpp-stark -- -seed="$RPP_FUZZ_SEED" -runs=32 -timeout=5
