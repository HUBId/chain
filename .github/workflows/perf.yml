name: Performance smoke benchmark

permissions:
  contents: read
  pull-requests: write

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      pr-number:
        description: 'Optional pull request number to comment on'
        required: false
      dashboard-endpoint:
        description: 'Optional URL to receive the summarized JSON payload'
        required: false

jobs:
  smoke:
    name: Firewood smoke benchmark
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install nightly toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: smoke-benchmark

      - name: Run smoke benchmark
        env:
          FIREWOOD_SMOKE_OUTPUT: smoke-metrics.json
        run: |
          set -euo pipefail
          cargo +nightly run -p firewood-benchmark -- smoke \
            | tee smoke-benchmark.log

      - name: Summarize metrics
        run: |
          set -euo pipefail
          python3 tools/perf_smoke_summary.py \
            --metrics smoke-metrics.json \
            --summary-md smoke-summary.md \
            --summary-json smoke-summary.json \
            --summary-html smoke-summary.html

      - name: Comment summary on pull request
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.pr-number != '')
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.inputs.pr-number }}
        with:
          script: |
            const fs = require('fs');
            const prNumber = Number(process.env.PR_NUMBER);
            if (!prNumber) {
              core.info('No pull request target provided; skipping summary comment');
              return;
            }

            const summary = fs.readFileSync('smoke-summary.md', 'utf8');
            const body = [
              'Performance smoke benchmark summary:',
              '',
              summary.trim(),
              '',
              'Additional artifacts: `smoke-summary.json` (machine readable) and `smoke-summary.html` (rich view).',
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });

      - name: Validate performance Grafana dashboards
        env:
          PERF_GRAFANA_URL: ${{ secrets.PERF_GRAFANA_URL }}
          PERF_GRAFANA_API_KEY: ${{ secrets.PERF_GRAFANA_API_KEY }}
        run: |
          set -euo pipefail
          tools/perf_dashboard_check.sh --manifest docs/performance_dashboards.json

      - name: Publish summary to dashboard endpoint
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.dashboard-endpoint != ''
        env:
          DASHBOARD_ENDPOINT: ${{ github.event.inputs.dashboard-endpoint }}
          DASHBOARD_TOKEN: ${{ secrets.PERF_DASHBOARD_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${DASHBOARD_TOKEN:-}" ]; then
            echo "PERF_DASHBOARD_TOKEN is not configured; skipping dashboard upload"
            exit 0
          fi

          curl --fail-with-body \
            -X POST \
            -H "Authorization: Bearer ${DASHBOARD_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @smoke-summary.json \
            "${DASHBOARD_ENDPOINT}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: smoke-benchmark
          path: |
            smoke-benchmark.log
            smoke-metrics.json
            smoke-summary.md
            smoke-summary.json
            smoke-summary.html
