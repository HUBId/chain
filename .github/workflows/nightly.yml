name: nightly-simnet

on:
  schedule:
    - cron: '30 1 * * *'
  workflow_dispatch:

jobs:
  timetoke-slo-report:
    name: Timetoke replay SLO report
    runs-on: ubuntu-latest
    env:
      TIMETOKE_PROMETHEUS_URL: ${{ secrets.TIMETOKE_PROMETHEUS_URL }}
      TIMETOKE_PROMETHEUS_BEARER: ${{ secrets.TIMETOKE_PROMETHEUS_BEARER }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Generate Timetoke SLO report
        run: |
          set -euo pipefail
          if [ -n "${TIMETOKE_PROMETHEUS_URL:-}" ]; then
            cargo xtask report-timetoke-slo \
              --prometheus-url "${TIMETOKE_PROMETHEUS_URL}" \
              --output timetoke-slo-report.md
          else
            cargo xtask report-timetoke-slo \
              --metrics-log docs/observability/examples/timetoke_metrics.jsonl \
              --output timetoke-slo-report.md
          fi

      - name: Upload SLO report
        uses: actions/upload-artifact@v4
        with:
          name: timetoke-slo-report
          path: timetoke-slo-report.md

  plonky3-hash-audit:
    name: Plonky3 release hash audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Determine latest release tag
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag=$(gh release view --json tagName --jq '.tagName')
          if [[ -z "$tag" ]]; then
            echo "::error::Unable to determine latest release tag" >&2
            exit 1
          fi
          echo "tag=$tag" >>"$GITHUB_OUTPUT"
      - name: Download release manifests
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p dist/release
          gh release download "${{ steps.release.outputs.tag }}" \
            --pattern 'plonky3-setup-hashes.json*' \
            --pattern 'SHA256SUMS.txt*' \
            --dir dist/release
      - uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.4.0'
      - name: Verify checksum manifest signature
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          cosign verify-blob \
            --certificate dist/release/SHA256SUMS.txt.pem \
            --signature dist/release/SHA256SUMS.txt.sig \
            dist/release/SHA256SUMS.txt
      - name: Verify Plonky3 hash manifest signature
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          cosign verify-blob \
            --certificate dist/release/plonky3-setup-hashes.json.pem \
            --signature dist/release/plonky3-setup-hashes.json.sig \
            dist/release/plonky3-setup-hashes.json
      - name: Compute repository hash manifest
        run: |
          set -euo pipefail
          python3 scripts/generate_plonky3_artifacts.py \
            config/plonky3/setup \
            --verify \
            --hash-output dist/local-plonky3-setup-hashes.json
      - name: Compare repository and release manifests
        run: |
          set -euo pipefail
          if ! cmp -s dist/local-plonky3-setup-hashes.json dist/release/plonky3-setup-hashes.json; then
            echo "::error::Repository and release Plonky3 hash manifests differ" >&2
            diff -u dist/release/plonky3-setup-hashes.json dist/local-plonky3-setup-hashes.json || true
            exit 1
          fi
      - name: Validate checksum entry for hash manifest
        run: |
          set -euo pipefail
          release_sha=$(grep ' dist/plonky3-setup-hashes.json$' dist/release/SHA256SUMS.txt | awk '{print $1}')
          if [[ -z "$release_sha" ]]; then
            echo "::error::SHA256SUMS.txt does not contain dist/plonky3-setup-hashes.json" >&2
            exit 1
          fi
          local_sha=$(sha256sum dist/local-plonky3-setup-hashes.json | awk '{print $1}')
          if [[ "$release_sha" != "$local_sha" ]]; then
            echo "::error::Checksum mismatch for dist/plonky3-setup-hashes.json" >&2
            echo "release: $release_sha" >&2
            echo "local:   $local_sha" >&2
            exit 1
          fi
  validation:
    name: Nightly validation (${{ matrix.name }})
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            features: ""
            no_default_features: ""
            experimental: false
          - name: prod-stwo
            features: "prod,prover-stwo"
            no_default_features: "1"
            experimental: false
          - name: prod-stwo-plonky3
            features: "prod,prover-stwo,backend-plonky3"
            no_default_features: "1"
            experimental: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Execute xtask test-all
        run: |
          set -euo pipefail
          if [ -n "${{ matrix.no_default_features }}" ]; then
            export XTASK_NO_DEFAULT_FEATURES="${{ matrix.no_default_features }}"
          fi
          if [ -n "${{ matrix.features }}" ]; then
            export XTASK_FEATURES='${{ matrix.features }}'
          fi
          cargo xtask test-all

  plonky3-gpu:
    name: Plonky3 GPU smoke
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-C debuginfo=0"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build GPU backend
        run: |
          set -euo pipefail
          cargo build -p plonky3-backend --no-default-features --features plonky3-gpu

      - name: GPU backend smoke test
        run: |
          set -euo pipefail
          cargo test -p plonky3-backend --no-default-features --features plonky3-gpu -- consensus_proof_metadata_tracks_commitment_digest

  simnet:
    name: Simnet harness (prod, prover-stwo, plonky3)
    runs-on: ubuntu-latest
    env:
      XTASK_NO_DEFAULT_FEATURES: "1"
      XTASK_FEATURES: "prod,prover-stwo,backend-plonky3"
      RUSTFLAGS: "-C debuginfo=0"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Execute simnet harness
        run: |
          set -euo pipefail
          cargo xtask test-simnet

      - name: Analyze summaries
        run: |
          set -euo pipefail
          python3 scripts/analyze_simnet.py \
            target/simnet/ci-block-pipeline/summaries/ci-block-pipeline.json \
            target/simnet/ci-state-sync-guard/summaries/ci-state-sync-guard.json \
            target/simnet/consensus-quorum-stress/summaries/consensus_quorum_stress.json \
            target/simnet/snapshot-partition/summaries/snapshot_partition.json

      - name: Package artifacts
        run: |
          tar -czf simnet-artifacts.tar.gz -C target simnet

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: simnet-nightly
          path: simnet-artifacts.tar.gz

  simnet-regression:
    name: Simnet regression (prod, plonky3)
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-C debuginfo=0"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Execute regression sweep
        run: |
          set -euo pipefail
          rm -rf target/simnet/regression-nightly
          cargo run -p simnet --bin regression -- \
            --artifacts-root target/simnet/regression-nightly
      - name: Package regression artifacts
        run: |
          tar -czf simnet-regression.tar.gz -C target/simnet regression-nightly
      - name: Upload regression archive
        uses: actions/upload-artifact@v4
        with:
          name: simnet-regression-nightly
          path: simnet-regression.tar.gz
