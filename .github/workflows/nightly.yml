name: nightly-simnet

on:
  schedule:
    - cron: '30 1 * * *'
  workflow_dispatch:

jobs:
  validation:
    name: Nightly validation (${{ matrix.name }})
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            features: ""
            no_default_features: ""
            experimental: false
          - name: prod-stwo
            features: "prod,prover-stwo"
            no_default_features: "1"
            experimental: false
          - name: prod-stwo-plonky3
            features: "prod,prover-stwo,backend-plonky3"
            no_default_features: "1"
            experimental: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Execute xtask test-all
        run: |
          set -euo pipefail
          if [ -n "${{ matrix.no_default_features }}" ]; then
            export XTASK_NO_DEFAULT_FEATURES="${{ matrix.no_default_features }}"
          fi
          if [ -n "${{ matrix.features }}" ]; then
            export XTASK_FEATURES='${{ matrix.features }}'
          fi
          cargo xtask test-all

  simnet:
    name: Simnet harness (prod, prover-stwo, plonky3)
    runs-on: ubuntu-latest
    env:
      XTASK_NO_DEFAULT_FEATURES: "1"
      XTASK_FEATURES: "prod,prover-stwo,backend-plonky3"
      RUSTFLAGS: "-C debuginfo=0"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Execute simnet harness
        run: |
          set -euo pipefail
          cargo xtask test-simnet

      - name: Analyze summaries
        run: |
          set -euo pipefail
          python3 scripts/analyze_simnet.py \
            target/simnet/ci-block-pipeline/summaries/ci-block-pipeline.json \
            target/simnet/ci-state-sync-guard/summaries/ci-state-sync-guard.json \
            target/simnet/consensus-quorum-stress/summaries/consensus_quorum_stress.json

      - name: Package artifacts
        run: |
          tar -czf simnet-artifacts.tar.gz -C target simnet

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: simnet-nightly
          path: simnet-artifacts.tar.gz
