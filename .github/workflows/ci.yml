name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  plonky3-setup:
    name: Plonky3 setup reproducibility
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Regenerate Plonky3 setup artifacts
        run: |
          set -euo pipefail
          make plonky3-setup
      - name: Verify manifest digests
        run: |
          set -euo pipefail
          python3 - <<'PY'
import hashlib
import json
import sys
from pathlib import Path

root = Path('config/plonky3/setup')
manifest_path = root / 'manifest.json'
data = json.loads(manifest_path.read_text())

expected = {}
for entry in data.get('artifacts', []):
    expected[entry['file']] = entry['sha256']

missing = sorted(expected.keys())
actual = {}
for path in root.glob('*.json'):
    if path.name == 'manifest.json':
        continue
    actual[path.name] = hashlib.sha256(path.read_bytes()).hexdigest()

errors = False
for file, digest in sorted(actual.items()):
    recorded = expected.get(file)
    if recorded is None:
        print(f"::error file={file}::Missing manifest entry", file=sys.stderr)
        errors = True
        continue
    if recorded != digest:
        print(f"::error file={file}::Digest mismatch: expected {recorded}, found {digest}", file=sys.stderr)
        errors = True

unexpected = sorted(set(expected.keys()) - set(actual.keys()))
for file in unexpected:
    print(f"::error file={file}::Manifest entry has no matching artifact", file=sys.stderr)
    errors = True

if errors:
    sys.exit(1)
PY
      - name: Ensure setup artifacts are committed
        run: |
          set -euo pipefail
          if ! git diff --quiet -- config/plonky3/setup; then
            git status --short config/plonky3/setup
            git diff config/plonky3/setup
            exit 1
          fi

  dashboards-json:
    name: Validate dashboard exports
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Validate Grafana JSON exports
        run: |
          set -euo pipefail
          command -v jq >/dev/null 2>&1
          files=(
            "dashboards/pipeline_overview.json"
            "dashboards/pipeline_wallet_intake.json"
            "dashboards/pipeline_proof_validation.json"
            "dashboards/pipeline_consensus_finality.json"
            "dashboards/pipeline_storage_commit.json"
            "dashboards/vrf_overview.json"
            "dashboards/vrf_thresholds.json"
            "dashboards/consensus_proof_validation.json"
            "observability/pipeline_grafana.json"
          )
          missing=0
          for file in "${files[@]}"; do
            path="docs/${file}"
            if [[ ! -f "${path}" ]]; then
              echo "::error file=${path}::Dashboard export is missing"
              missing=1
              continue
            fi
            jq empty "${path}"
          done
          python -m pip install --quiet 'pyyaml>=6'
          python - <<'PY'
import sys
from pathlib import Path

import yaml

          files = [
    Path("docs/observability/alerts/root_integrity.yaml"),
    Path("docs/observability/alerts/consensus_vrf.yaml"),
]

error = False

for path in files:
    if not path.exists():
        print(f"::error file={path}::Alert definition is missing", file=sys.stderr)
        error = True
        continue

    try:
        data = yaml.safe_load(path.read_text())
    except yaml.YAMLError as exc:  # pragma: no cover - CI linting
        print(f"::error file={path}::Failed to parse YAML: {exc}", file=sys.stderr)
        error = True
        continue

    if not isinstance(data, dict):
        print(f"::error file={path}::Alert definition must be a mapping", file=sys.stderr)
        error = True
        continue

    for key in ("apiVersion", "kind", "metadata", "spec"):
        if key not in data:
            print(f"::error file={path}::Missing required top-level key '{key}'", file=sys.stderr)
            error = True

    spec = data.get("spec", {})
    groups = spec.get("groups") if isinstance(spec, dict) else None
    if not isinstance(groups, list) or not groups:
        print(f"::error file={path}::spec.groups must be a non-empty list", file=sys.stderr)
        error = True
        continue

    for group in groups:
        if not isinstance(group, dict):
            print(f"::error file={path}::Each group must be a mapping", file=sys.stderr)
            error = True
            continue
        rules = group.get("rules")
        if not isinstance(rules, list) or not rules:
            print(f"::error file={path}::Each group must define non-empty rules", file=sys.stderr)
            error = True
            continue
        for rule in rules:
            if not isinstance(rule, dict):
                print(f"::error file={path}::Each rule must be a mapping", file=sys.stderr)
                error = True
                continue
            for required in ("alert", "expr"):
                if required not in rule:
                    print(
                        f"::error file={path}::Rule missing required key '{required}'",
                        file=sys.stderr,
                    )
                    error = True

if error:
    sys.exit(1)
PY
          if [[ ${missing} -ne 0 ]]; then
            echo "One or more dashboard exports are missing."
            exit 1
          fi

  unit-suites:
    name: Unit suites (${{ matrix.name }})
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            features: ""
            no_default_features: ""
            experimental: false
          - name: prod-stwo
            features: "prod,prover-stwo"
            no_default_features: "1"
            experimental: false
          - name: prod-stwo-plonky3
            features: "prod,prover-stwo,backend-plonky3"
            no_default_features: "1"
            experimental: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run unit validation suites
        run: |
          set -euo pipefail
          if [ -n "${{ matrix.no_default_features }}" ]; then
            export XTASK_NO_DEFAULT_FEATURES="${{ matrix.no_default_features }}"
          fi
          if [ -n "${{ matrix.features }}" ]; then
            export XTASK_FEATURES='${{ matrix.features }}'
          fi
          cargo xtask test-unit

  integration-workflows:
    name: Integration workflows (${{ matrix.name }})
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            features: ""
            no_default_features: ""
            experimental: false
          - name: prod-stwo
            features: "prod,prover-stwo"
            no_default_features: "1"
            experimental: false
          - name: prod-stwo-plonky3
            features: "prod,prover-stwo,backend-plonky3"
            no_default_features: "1"
            experimental: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run integration workflows
        run: |
          set -euo pipefail
          if [ -n "${{ matrix.no_default_features }}" ]; then
            export XTASK_NO_DEFAULT_FEATURES="${{ matrix.no_default_features }}"
          fi
          if [ -n "${{ matrix.features }}" ]; then
            export XTASK_FEATURES='${{ matrix.features }}'
          fi
          cargo xtask test-integration

  simnet-smoke:
    name: Simnet smoke (${{ matrix.name }})
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            features: ""
            no_default_features: ""
            experimental: false
          - name: prod-stwo
            features: "prod,prover-stwo"
            no_default_features: "1"
            experimental: false
          - name: prod-stwo-plonky3
            features: "prod,prover-stwo,backend-plonky3"
            no_default_features: "1"
            experimental: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run simnet scenario
        run: |
          set -euo pipefail
          if [ -n "${{ matrix.no_default_features }}" ]; then
            export XTASK_NO_DEFAULT_FEATURES="${{ matrix.no_default_features }}"
          fi
          if [ -n "${{ matrix.features }}" ]; then
            export XTASK_FEATURES='${{ matrix.features }}'
          fi
          cargo xtask test-simnet

  simnet-regression:
    name: Simnet regression sweep
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run regression harness
        run: |
          set -euo pipefail
          rm -rf target/simnet/regression-ci
          cargo run -p simnet --bin regression -- \
            --artifacts-root target/simnet/regression-ci
      - name: Upload regression artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simnet-regression
          path: target/simnet/regression-ci
