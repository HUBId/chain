name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  plonky3-setup:
    name: Plonky3 setup reproducibility
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: plonky3-setup
      - name: Regenerate Plonky3 setup artifacts
        run: |
          set -euo pipefail
          make plonky3-setup
      - name: Verify manifest digests
        run: |
          set -euo pipefail
          python3 - <<'PY'
import hashlib
import json
import sys
from pathlib import Path

root = Path('config/plonky3/setup')
manifest_path = root / 'manifest.json'
data = json.loads(manifest_path.read_text())

expected = {}
for entry in data.get('artifacts', []):
    expected[entry['file']] = entry['sha256']

missing = sorted(expected.keys())
actual = {}
for path in root.glob('*.json'):
    if path.name == 'manifest.json':
        continue
    actual[path.name] = hashlib.sha256(path.read_bytes()).hexdigest()

errors = False
for file, digest in sorted(actual.items()):
    recorded = expected.get(file)
    if recorded is None:
        print(f"::error file={file}::Missing manifest entry", file=sys.stderr)
        errors = True
        continue
    if recorded != digest:
        print(f"::error file={file}::Digest mismatch: expected {recorded}, found {digest}", file=sys.stderr)
        errors = True

unexpected = sorted(set(expected.keys()) - set(actual.keys()))
for file in unexpected:
    print(f"::error file={file}::Manifest entry has no matching artifact", file=sys.stderr)
    errors = True

if errors:
    sys.exit(1)
PY
      - name: Cross-check embedded hash manifests
        run: |
          set -euo pipefail
          python3 scripts/generate_plonky3_artifacts.py \
            config/plonky3/setup \
            --verify \
            --hash-output target/plonky3-setup-hashes.json
      - name: Ensure setup artifacts are committed
        run: |
          set -euo pipefail
          if ! git diff --quiet -- config/plonky3/setup; then
            git status --short config/plonky3/setup
            git diff config/plonky3/setup
            exit 1
          fi

  secure-keystore-lint:
    name: Secure keystore lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate production keystore settings
        run: |
          set -euo pipefail
          python3 scripts/ci/lint_secure_keystores.py

  phasec-status-freshness:
    name: Phase‑C status freshness
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Validate phaseC_status.md is current
        env:
          MAX_AGE_HOURS: 192
        run: |
          set -euo pipefail

          timestamp_line=$(sed -n 's/^### Phase‑C Kontrollen — //p' phaseC_status.md | head -n 1)
          if [[ -z "$timestamp_line" ]]; then
            echo "::error file=phaseC_status.md::Konnte Phase‑C-Zeitstempel nicht lesen" >&2
            exit 1
          fi

          if ! timestamp_epoch=$(date -u -d "$timestamp_line" +%s 2>/dev/null); then
            printf '::error file=phaseC_status.md::Ungültiger Zeitstempel "%s"\n' "$timestamp_line" >&2
            exit 1
          fi

          now_epoch=$(date -u +%s)
          age_hours=$(( (now_epoch - timestamp_epoch) / 3600 ))
          max_age=${MAX_AGE_HOURS:-192}

          missing_sections=()
          if ! grep -Fq 'WORM-Retention' phaseC_status.md; then
            missing_sections+=("WORM-Retention")
          fi
          if ! grep -Fq 'Snapshot Partition Drill' phaseC_status.md; then
            missing_sections+=("Snapshot Partition Drill")
          fi

          if (( age_hours > max_age )); then
            printf '::error file=phaseC_status.md::Phase‑C-Status ist %sh alt (Limit %sh)\n' "$age_hours" "$max_age" >&2
            exit 1
          fi

          if [[ ${#missing_sections[@]} -gt 0 ]]; then
            printf '::error file=phaseC_status.md::Fehlende Tabellenzeilen: %s\n' "${missing_sections[*]}" >&2
            exit 1
          fi

          printf 'Phase‑C-Status ist %sh alt und enthält WORM-/Chaos-Einträge.\n' "$age_hours"

  dashboards-json:
    name: Validate dashboard exports
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Validate Grafana JSON exports
        run: |
          set -euo pipefail
          command -v jq >/dev/null 2>&1
          files=(
            "dashboards/pipeline_overview.json"
            "dashboards/pipeline_wallet_intake.json"
            "dashboards/pipeline_proof_validation.json"
            "dashboards/pipeline_consensus_finality.json"
            "dashboards/pipeline_storage_commit.json"
            "dashboards/vrf_overview.json"
            "dashboards/vrf_thresholds.json"
            "dashboards/consensus_proof_validation.json"
            "observability/pipeline_grafana.json"
          )
          missing=0
          for file in "${files[@]}"; do
            path="docs/${file}"
            if [[ ! -f "${path}" ]]; then
              echo "::error file=${path}::Dashboard export is missing"
              missing=1
              continue
            fi
            jq empty "${path}"
          done
          python -m pip install --quiet 'pyyaml>=6'
          python - <<'PY'
import sys
from pathlib import Path

import yaml

files = [
    Path("docs/observability/alerts/root_integrity.yaml"),
    Path("docs/observability/alerts/consensus_vrf.yaml"),
    Path("docs/observability/alerts/snapshot_stream.yaml"),
]

error = False

for path in files:
    if not path.exists():
        print(f"::error file={path}::Alert definition is missing", file=sys.stderr)
        error = True
        continue

    try:
        data = yaml.safe_load(path.read_text())
    except yaml.YAMLError as exc:  # pragma: no cover - CI linting
        print(f"::error file={path}::Failed to parse YAML: {exc}", file=sys.stderr)
        error = True
        continue

    if not isinstance(data, dict):
        print(f"::error file={path}::Alert definition must be a mapping", file=sys.stderr)
        error = True
        continue

    for key in ("apiVersion", "kind", "metadata", "spec"):
        if key not in data:
            print(f"::error file={path}::Missing required top-level key '{key}'", file=sys.stderr)
            error = True

    spec = data.get("spec", {})
    groups = spec.get("groups") if isinstance(spec, dict) else None
    if not isinstance(groups, list) or not groups:
        print(f"::error file={path}::spec.groups must be a non-empty list", file=sys.stderr)
        error = True
        continue

    for group in groups:
        if not isinstance(group, dict):
            print(f"::error file={path}::Each group must be a mapping", file=sys.stderr)
            error = True
            continue
        rules = group.get("rules")
        if not isinstance(rules, list) or not rules:
            print(f"::error file={path}::Each group must define non-empty rules", file=sys.stderr)
            error = True
            continue
        for rule in rules:
            if not isinstance(rule, dict):
                print(f"::error file={path}::Each rule must be a mapping", file=sys.stderr)
                error = True
                continue
            for required in ("alert", "expr"):
                if required not in rule:
                    print(
                        f"::error file={path}::Rule missing required key '{required}'",
                        file=sys.stderr,
                    )
                    error = True

          if error:
              sys.exit(1)
PY
          if [[ ${missing} -ne 0 ]]; then
            echo "One or more dashboard exports are missing."
            exit 1
          fi

      - name: Enforce dashboard manifest versions
        run: |
          set -euo pipefail
          python3 scripts/verify_dashboard_manifest.py

  testing-matrix-docs:
    name: CI testing matrix doc guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Validate testing matrix coverage doc
        run: |
          set -euo pipefail
          python3 scripts/ci/check_testing_matrix.py

  wallet-windows-build:
    name: Wallet Windows build
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
      - name: Build wallet CLI and GUI bundles
        shell: bash
        run: |
          set -euo pipefail
          cargo build --locked \
            -p rpp-wallet \
            --no-default-features \
            --features "runtime,prover-stwo,backup,wallet_multisig_hooks,wallet_rpc_mtls,wallet_hw"
          cargo build --locked \
            -p rpp-wallet-lib \
            --bin rpp-wallet-gui \
            --no-default-features \
            --features "wallet_gui,prover-stwo,backup"

  wallet-sdk-mobile-embedded:
    name: Wallet SDK mobile/embedded smoke
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: wallet-sdk-mobile-embedded
      - name: Run mobile/embedded SDK flows against test node shim
        run: |
          set -euo pipefail
          cargo test --locked --test sdk_mobile_embedded_smoke --features "wallet-integration" -- --nocapture
      - name: Upload SDK smoke logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: wallet-sdk-mobile-embedded-logs
          path: logs/sdk-smoke

  proof-version-policy:
    name: Proof version policy
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: proof-version-guard
      - name: Enforce PROOF_VERSION policy
        env:
          PROOF_VERSION_GUARD_BASE: origin/${{ github.base_ref }}
        run: |
          set -euo pipefail
          cargo xtask proof-version-guard
      - name: Verify proof metadata alignment
        run: |
          set -euo pipefail
          cargo xtask proof-version-metadata
      - name: Exercise mixed-circuit upgrade guardrails
        run: |
          set -euo pipefail
          cargo test -p rpp-chain --locked --features backend-rpp-stark --test rpp_circuit_rollback -- \
            mixed_circuit_versions_reject_incompatible_proofs

  clippy:
    name: Clippy (all targets, all features)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: clippy
      - name: Run Clippy
        run: |
          set -euo pipefail
          cargo clippy --workspace --all-targets --all-features -- -D warnings -D clippy::panic -D clippy::unwrap_used -D clippy::expect_used

  panic-lints:
    name: Panic/unwrap guard (consensus + verifier)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: panic-lints
      - name: Enforce panic policy on consensus + snapshot verifier
        run: |
          set -euo pipefail
          cargo clippy --manifest-path rpp/consensus/Cargo.toml --all-targets --all-features -- -D warnings -D clippy::panic -D clippy::unwrap_used -D clippy::expect_used
          cargo clippy -p snapshot-verify --all-targets --all-features -- -D warnings -D clippy::panic -D clippy::unwrap_used -D clippy::expect_used

  cargo-audit:
    name: Dependency advisories
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: cargo-audit
      - name: Restore advisory database cache
        uses: actions/cache@v3
        with:
          path: ~/.cargo/advisory-db
          key: ${{ runner.os }}-cargo-advisory-db-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-advisory-db-
      - name: Install cargo-audit
        run: |
          set -euo pipefail
          cargo install --locked cargo-audit
      - name: Update advisory database
        run: |
          set -euo pipefail
          cargo audit fetch
      - name: Check for advisories
        run: |
          set -euo pipefail
          cargo audit --deny warnings

  wallet-supply-chain:
    name: Wallet supply-chain audit (${{ matrix.name }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: rpp-wallet-lib
            manifest: rpp/wallet/Cargo.toml
          - name: rpp-wallet
            manifest: rpp/wallet-runner/Cargo.toml
          - name: rpp-wallet-interface
            manifest: rpp/wallet-interface/Cargo.toml
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: wallet-supply-chain-${{ matrix.name }}
      - name: Restore advisory database cache
        uses: actions/cache@v3
        with:
          path: ~/.cargo/advisory-db
          key: ${{ runner.os }}-wallet-advisory-db-${{ matrix.name }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-wallet-advisory-db-${{ matrix.name }}-
      - name: Install supply-chain tooling
        run: |
          set -euo pipefail
          cargo install --locked cargo-audit
          cargo install --locked cargo-deny
      - name: Update advisory database
        run: |
          set -euo pipefail
          cargo audit fetch
      - name: Run cargo audit (wallet)
        run: |
          set -euo pipefail
          cargo audit --deny warnings --manifest-path "${{ matrix.manifest }}"
      - name: Run cargo deny (wallet)
        run: |
          set -euo pipefail
          cargo deny --manifest-path "${{ matrix.manifest }}" --config config/security/cargo-deny-wallet.toml check advisories bans licenses sources

  alerts-lint:
    name: Alert manifest lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Spectral CLI
        run: npm install -g @stoplight/spectral-cli@6
      - name: Lint alert definitions
        run: |
          set -euo pipefail
          spectral lint docs/observability/alerts/*.yaml \
            -r docs/observability/alerts/.spectral.yaml

  alert-probes:
    name: Alert probes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install probe dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install -r tools/alerts/requirements.txt
      - name: Run alert probes
        env:
          ALERT_PROBE_ARTIFACT_DIR: artifacts/alert-probes
        run: |
          set -euo pipefail
          mkdir -p "$ALERT_PROBE_ARTIFACT_DIR"
          status=0
          set +e
          python -m pytest tools/alerts/tests
          status=$((status | $?))
          python tools/alerts/validate_alerts.py --artifacts "$ALERT_PROBE_ARTIFACT_DIR"
          status=$((status | $?))
          set -e
          echo "$status" > "$ALERT_PROBE_ARTIFACT_DIR/exit_code.txt"
          exit "$status"
      - name: Upload probe artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: alert-probes
          path: artifacts/alert-probes

  alert-config-drift:
    name: Alert config drift
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install alert tooling
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install -r tools/alerts/requirements.txt

      - name: Render staging alert bundle
        run: |
          set -euo pipefail
          python tools/alerts/render_environment_rules.py \
            --source ops/alerts \
            --output artifacts/alerts/staging \
            --environment staging

      - name: Render production alert bundle
        run: |
          set -euo pipefail
          python tools/alerts/render_environment_rules.py \
            --source ops/alerts \
            --output artifacts/alerts/production \
            --environment production

      - name: Validate rendered staging alerts
        run: |
          set -euo pipefail
          ruby scripts/ci/validate_prometheus_rules.rb artifacts/alerts/staging

      - name: Validate rendered production alerts
        run: |
          set -euo pipefail
          ruby scripts/ci/validate_prometheus_rules.rb artifacts/alerts/production

      - name: Detect staging/production drift
        run: |
          set -euo pipefail
          python tools/alerts/compare_environment_rules.py \
            --staging artifacts/alerts/staging \
            --production artifacts/alerts/production

  uptime-baseline-guard:
    name: Uptime/timetoke baseline drift check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install baseline check dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install -r tools/alerts/requirements.txt

      - name: Compare metrics to buffered baselines
        run: |
          set -euo pipefail
          python tools/alerts/check_baseline_metrics.py \
            --metrics-log tools/alerts/fixtures/uptime_timetoke.prom \
            --environment staging

  staging-slo-probes:
    name: Staging SLO probes
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    env:
      SNAPSHOT_RPC_URL: ${{ secrets.SNAPSHOT_RPC_URL }}
      SNAPSHOT_RPC_TOKEN: ${{ secrets.SNAPSHOT_RPC_TOKEN }}
      SNAPSHOT_VALIDATOR_CONFIG: ${{ secrets.SNAPSHOT_VALIDATOR_CONFIG }}
      SNAPSHOT_MANIFEST_PATH: ${{ secrets.SNAPSHOT_MANIFEST_PATH }}
      SNAPSHOT_MANIFEST_JSON: ${{ secrets.SNAPSHOT_MANIFEST_JSON }}
      SNAPSHOT_MANIFEST_PUBKEY_HEX: ${{ secrets.SNAPSHOT_MANIFEST_PUBKEY_HEX }}
      SNAPSHOT_CHUNK_ROOT: ${{ secrets.SNAPSHOT_CHUNK_ROOT }}
      SNAPSHOT_CHUNK_ARCHIVE_URL: ${{ secrets.SNAPSHOT_CHUNK_ARCHIVE_URL }}
      SNAPSHOT_CHUNK_ROOT_SUBDIR: ${{ secrets.SNAPSHOT_CHUNK_ROOT_SUBDIR }}
      SNAPSHOT_MANIFEST_SIGNATURE_PATH: ${{ secrets.SNAPSHOT_MANIFEST_SIGNATURE_PATH }}
      SNAPSHOT_MANIFEST_SIGNATURE: ${{ secrets.SNAPSHOT_MANIFEST_SIGNATURE }}
      TIMETOKE_PROMETHEUS_URL: ${{ secrets.TIMETOKE_PROMETHEUS_URL }}
      TIMETOKE_PROMETHEUS_BEARER: ${{ secrets.TIMETOKE_PROMETHEUS_BEARER }}
      ADMISSION_RPC_URL: ${{ secrets.ADMISSION_RPC_URL }}
      ADMISSION_RPC_TOKEN: ${{ secrets.ADMISSION_RPC_TOKEN }}
      ADMISSION_POLICY_PATH: ${{ secrets.ADMISSION_POLICY_PATH }}
      ADMISSION_MAX_AUDIT_LAG_SECS: ${{ secrets.ADMISSION_MAX_AUDIT_LAG_SECS }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Validate staging probe inputs
        run: |
          set -euo pipefail
          required=(TIMETOKE_PROMETHEUS_URL SNAPSHOT_RPC_URL ADMISSION_RPC_URL)
          missing=0
          for var in "${required[@]}"; do
            if [[ -z "${!var:-}" ]]; then
              echo "::error::Missing $var for staging SLO probes" >&2
              missing=1
            fi
          done
          if [[ "$missing" -ne 0 ]]; then
            exit 1
          fi

      - name: Run staging SLO probes
        id: staging
        run: |
          set -euo pipefail
          mkdir -p artifacts/staging-slo-probes
          args=(staging-soak --output-dir artifacts/staging-slo-probes)
          [[ -n "${SNAPSHOT_VALIDATOR_CONFIG:-}" ]] && args+=(--snapshot-config "$SNAPSHOT_VALIDATOR_CONFIG")
          [[ -n "${SNAPSHOT_RPC_URL:-}" ]] && args+=(--snapshot-rpc-url "$SNAPSHOT_RPC_URL")
          [[ -n "${SNAPSHOT_RPC_TOKEN:-}" ]] && args+=(--snapshot-auth-token "$SNAPSHOT_RPC_TOKEN")
          [[ -n "${SNAPSHOT_MANIFEST_PATH:-}" ]] && args+=(--snapshot-manifest "$SNAPSHOT_MANIFEST_PATH")
          [[ -n "${TIMETOKE_PROMETHEUS_URL:-}" ]] && args+=(--timetoke-prometheus-url "$TIMETOKE_PROMETHEUS_URL")
          [[ -n "${TIMETOKE_PROMETHEUS_BEARER:-}" ]] && args+=(--timetoke-bearer-token "$TIMETOKE_PROMETHEUS_BEARER")
          [[ -n "${ADMISSION_RPC_URL:-}" ]] && args+=(--admission-rpc-url "$ADMISSION_RPC_URL")
          [[ -n "${ADMISSION_RPC_TOKEN:-}" ]] && args+=(--admission-auth-token "$ADMISSION_RPC_TOKEN")
          [[ -n "${ADMISSION_POLICY_PATH:-}" ]] && args+=(--admission-policy-path "$ADMISSION_POLICY_PATH")
          [[ -n "${ADMISSION_MAX_AUDIT_LAG_SECS:-}" ]] && args+=(--admission-max-audit-lag-secs "$ADMISSION_MAX_AUDIT_LAG_SECS")
          set +e
          cargo xtask "${args[@]}"
          status=$?
          set -e
          summary=$(find artifacts/staging-slo-probes -name summary.json -print | sort | tail -n 1)
          if [[ -n "$summary" ]]; then
            echo "summary_path=$summary" >>"$GITHUB_OUTPUT"
          fi
          echo "exit_status=$status" >>"$GITHUB_OUTPUT"
          exit "$status"

      - name: Upload staging SLO probe artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: staging-slo-probes
          path: artifacts/staging-slo-probes

  docker-images:
    name: Build container images (${{ matrix.name }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: rpp-node
            dockerfile: rpp/node/Dockerfile
            image: rpp/node
          - name: fwdctl
            dockerfile: fwdctl/Dockerfile
            image: fwdctl
          - name: simnet
            dockerfile: tools/simnet/Dockerfile
            image: tools/simnet
          - name: validator-ui
            dockerfile: validator-ui/Dockerfile
            image: validator-ui
    env:
      REGISTRY: ghcr.io/${{ github.repository_owner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ matrix.image }}
          tags: |
            type=sha,format=long
            type=ref,event=branch
            type=ref,event=pr
      - name: Log in to GHCR
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,scope=${{ matrix.name }},mode=max

  smoke-test:
    name: Docker compose smoke test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Prepare compose environment
        run: |
          set -euo pipefail
          cp .env.example .env
          {
            echo 'RPP_NODE_RPC_PORT=8080'
            echo 'RPP_NODE_METRICS_PORT=9797'
            echo 'VALIDATOR_UI_PORT=3000'
            echo 'VALIDATOR_UI_API_BASE_URL=http://rpp-node:8080'
            echo 'RPP_NODE_CONFIG_HOST_PATH=./config/node.telemetry.metrics.toml'
          } >>.env
      - name: Build and start services
        env:
          DOCKER_BUILDKIT: "1"
        run: |
          set -euo pipefail
          if docker compose config --services | grep -qx node; then
            docker compose up -d node validator-ui
          else
            docker compose up -d rpp-node validator-ui
          fi
      - name: Wait for node readiness endpoint
        run: |
          set -euo pipefail
          for attempt in $(seq 1 30); do
            if curl --fail --silent --show-error http://127.0.0.1:8080/health/ready >/dev/null; then
              exit 0
            fi
            sleep 5
          done
          echo 'Node readiness endpoint did not become healthy in time' >&2
          exit 1

      - name: Fetch metrics endpoint
        run: |
          set -euo pipefail
          curl --fail --silent --show-error http://127.0.0.1:9797/metrics | head -n 5
      - name: Wait for validator UI
        run: |
          set -euo pipefail
          for attempt in $(seq 1 30); do
            if curl --fail --silent --show-error http://127.0.0.1:3000/ >/dev/null; then
              exit 0
            fi
            sleep 5
          done
          echo 'Validator UI did not become ready in time' >&2
          exit 1
      - name: Tear down services
        if: always()
        run: |
          set -euo pipefail
          docker compose down --volumes --remove-orphans

  runtime-smoke:
    name: Runtime smoke health checks
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: runtime-smoke
      - name: Build runtime binary
        run: |
          set -euo pipefail
          cargo build --bin rpp-node
      - name: Exercise runtime modes
        env:
          RPP_NODE_BIN: "${{ github.workspace }}/target/debug/rpp-node"
          RPP_SUPPRESS_EXPERIMENTAL_BACKEND_WARNING: "1"
        run: |
          set -euo pipefail
          mkdir -p artifacts/runtime-smoke

          wait_for_endpoint() {
            local pid="$1"
            local url="$2"
            local timeout="$3"
            local elapsed=0

            while (( elapsed < timeout )); do
              if ! kill -0 "$pid" 2>/dev/null; then
                wait "$pid" || true
                return 1
              fi
              if curl --fail --silent --show-error --max-time 5 "$url" >/dev/null 2>&1; then
                return 0
              fi
              sleep 1
              elapsed=$((elapsed + 1))
            done

            echo "error: $url did not become healthy within ${timeout}s" >&2
            return 1
          }

          run_mode() {
            local mode="$1"
            local script="$2"
            local metrics_url="$3"
            shift 3
            local -a health_endpoints=("$@")
            local log_file="artifacts/runtime-smoke/${mode}.log"
            local metrics_file="artifacts/runtime-smoke/${mode}.metrics"
            local timeout=150

            echo "::group::runtime smoke (${mode})"

            local data_dir
            data_dir="$(mktemp -d)"

            (
              export RPP_NODE_DATA_DIR="${data_dir}"
              "${script}"
            ) >"${log_file}" 2>&1 &
            local runner_pid=$!

            cleanup() {
              if kill -0 "${runner_pid}" 2>/dev/null; then
                kill -TERM "${runner_pid}" 2>/dev/null || true
                wait "${runner_pid}" 2>/dev/null || true
              fi
              rm -rf "${data_dir}"
            }

            trap cleanup EXIT

            local endpoint
            for endpoint in "${health_endpoints[@]}"; do
              echo "probing ${endpoint}"
              if ! wait_for_endpoint "${runner_pid}" "${endpoint}" "${timeout}"; then
                echo "::error title=${mode} health check failed::${endpoint} did not report healthy" >&2
                trap - EXIT
                cleanup
                return 1
              fi
            done

            if ! curl --fail --silent --show-error --max-time 10 "${metrics_url}" >"${metrics_file}"; then
              echo "::error title=${mode} metrics scrape failed::Unable to fetch metrics from ${metrics_url}" >&2
              trap - EXIT
              cleanup
              return 1
            fi

            kill -TERM "${runner_pid}" 2>/dev/null || true
            if ! wait "${runner_pid}"; then
              local status=$?
              if [[ ${status} -ne 0 && ${status} -ne 143 ]]; then
                echo "::error title=${mode} runtime exit code::Process exited with status ${status}" >&2
                trap - EXIT
                cleanup
                return 1
              fi
            fi

            trap - EXIT
            cleanup
            echo "::endgroup::"
          }

          run_mode \
            node \
            "${GITHUB_WORKSPACE}/scripts/run_node_mode.sh" \
            "http://127.0.0.1:7070/metrics" \
            "http://127.0.0.1:7070/health/live" \
            "http://127.0.0.1:7070/health/ready"

          run_mode \
            wallet \
            "${GITHUB_WORKSPACE}/scripts/run_wallet_mode.sh" \
            "http://127.0.0.1:9090/metrics" \
            "http://127.0.0.1:9090/health/live" \
            "http://127.0.0.1:9090/health/ready"

          run_mode \
            hybrid \
            "${GITHUB_WORKSPACE}/scripts/run_hybrid_mode.sh" \
            "http://127.0.0.1:7070/metrics" \
            "http://127.0.0.1:7070/health/live" \
            "http://127.0.0.1:7070/health/ready"

      - name: Upload runtime smoke artifacts
        uses: actions/upload-artifact@v4
        with:
          name: runtime-smoke
          path: artifacts/runtime-smoke

  firewood-unit:
    name: Firewood unit feature matrix (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            xtask_features: ""
          - name: io-uring
            xtask_features: "io-uring"
          - name: ethhash
            xtask_features: "ethhash"
          - name: branch-factor-256-ethhash
            xtask_features: "branch_factor_256,ethhash"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: firewood-unit-${{ matrix.name }}
      - name: Run Firewood unit tests across branch factors
        env:
          XTASK_FEATURES: ${{ matrix.xtask_features }}
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          cargo xtask test-firewood

  wallet-feature-matrix:
    name: Wallet feature matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: wallet-feature-matrix
      - name: Run wallet feature matrix
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          cargo xtask test-wallet-feature-matrix

  firewood-ffi-go:
    name: Firewood Go FFI tests (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            features: ""
          - name: backend-rpp-stark
            features: "backend-rpp-stark"
          - name: io-uring
            features: "io-uring"
          - name: ethhash
            features: "ethhash"
          - name: branch-factor-256-ethhash
            features: "branch_factor_256,ethhash"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: firewood-ffi-go-${{ matrix.name }}
      - name: Build Firewood FFI static library
        env:
          XTASK_FEATURES: ${{ matrix.features }}
        run: |
          set -euo pipefail
          if [ -n "${{ matrix.features }}" ]; then
            cargo build -p firewood-ffi --locked --features "${{ matrix.features }}"
          else
            cargo build -p firewood-ffi --locked
          fi
      - name: Run Go FFI tests
        working-directory: ffi
        env:
          XTASK_FEATURES: ${{ matrix.features }}
        run: |
          set -euo pipefail
          go test ./...

  firewood-giant-node:
    name: Firewood giant node (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            features: ""
          - name: backend-rpp-stark
            features: "backend-rpp-stark"
          - name: io-uring
            features: "io-uring"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: firewood-giant-node-${{ matrix.name }}
      - name: Run giant node regression
        run: |
          set -euo pipefail
          if [ -n "${{ matrix.features }}" ]; then
            cargo test -p firewood-storage --locked --features "${{ matrix.features }}" nodestore::tests::giant_node -- --exact
          else
            cargo test -p firewood-storage --locked nodestore::tests::giant_node -- --exact
          fi

  unit-suites:
    name: Unit suites (${{ matrix.name }})
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            features: ""
            no_default_features: ""
            experimental: false
          - name: backend-rpp-stark
            features: "backend-rpp-stark"
            no_default_features: ""
            experimental: false
          - name: prover-stwo-backend
            features: "prod,prover-stwo"
            no_default_features: "1"
            experimental: false
          - name: prod-stwo-plonky3
            features: "prod,prover-stwo,backend-plonky3"
            no_default_features: "1"
            experimental: false
          - name: wallet-gui
            features: "wallet_gui"
            no_default_features: ""
            experimental: false
          - name: wallet-advanced
            features: "wallet_zsi,wallet_hw,wallet_multisig_hooks,wallet_rpc_mtls"
            no_default_features: ""
            experimental: false
      steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.name }}
      - name: Run unit validation suites
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          if [ -n "${{ matrix.no_default_features }}" ]; then
            export XTASK_NO_DEFAULT_FEATURES="${{ matrix.no_default_features }}"
          fi
          if [ -n "${{ matrix.features }}" ]; then
            export XTASK_FEATURES='${{ matrix.features }}'
          fi
          cargo xtask test-unit
      - name: Compare rpp golden vector checksums
        if: matrix.name == 'backend-rpp-stark'
        run: scripts/ci/compare_rpp_vector_checksums.sh
      - name: Collect unit suite artifacts (${{ matrix.name }})
        if: always()
        run: |
          set -euo pipefail
          scripts/ci/collect_test_artifacts.sh "artifacts/unit-suites/${{ matrix.name }}" logs
      - name: Upload unit suite artifacts (${{ matrix.name }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-suites-${{ matrix.name }}
          path: artifacts/unit-suites/${{ matrix.name }}

  cli-smoke:
    name: CLI smoke (default + runtime-cli)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: cli-smoke
      - name: Run chain-cli smoke checks (dual default/runtime-cli passes)
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          cargo xtask test-cli
          cargo run -p rpp-chain -- --help >/dev/null
          cargo run -p rpp-node --bin rpp-node -- --help >/dev/null

  rpc-admission-audit:
    name: RPC admission audit guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rpc-admission-audit
      - name: Run dual-approval audit guard
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          cargo test -p rpp-chain --locked --test admission

  worm-export-smoke:
    name: WORM export pipeline smoke test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: worm-export
      - name: Exercise WORM export stub pipeline
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          cargo xtask test-worm-export
      - name: Validate WORM export failure guard
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          cargo test --test compliance --features integration -- worm_export_failure_emits_metric_and_log
      - name: Upload WORM smoke artifacts
        uses: actions/upload-artifact@v4
        with:
          name: worm-export-smoke
          path: target/worm-export-smoke

  pruning-checkpoints:
    name: Pruning checkpoints against finalized head
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: pruning-checkpoints
      - name: Validate pruning checkpoint replay
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          mkdir -p artifacts/pruning-checkpoints/default artifacts/pruning-checkpoints/rpp-stark
          cargo test -p rpp-chain --locked --features prover-stwo --test pruning_cross_backend -- \
            pruning_checkpoint_round_trip_default_backend \
            wallet_snapshot_round_trip_default_backend \
            2>&1 | tee artifacts/pruning-checkpoints/default/pruning-checkpoints.log
          cargo test -p rpp-chain --locked --features prover-stwo --test recovery_pruning -- \
            pruning_checkpoint_signature_rejects_tampered_payload \
            pruning_checkpoint_signature_rejects_tampered_signature \
            2>&1 | tee -a artifacts/pruning-checkpoints/default/pruning-checkpoints.log
          cargo test -p rpp-chain --locked --features backend-rpp-stark --test pruning_cross_backend -- \
            pruning_checkpoint_round_trip_rpp_stark_backend \
            wallet_snapshot_round_trip_rpp_stark_backend \
            2>&1 | tee artifacts/pruning-checkpoints/rpp-stark/pruning-checkpoints.log
          cargo test -p rpp-chain --locked --features backend-rpp-stark --test recovery_pruning -- \
            pruning_checkpoint_signature_rejects_tampered_payload \
            pruning_checkpoint_signature_rejects_tampered_signature \
            2>&1 | tee -a artifacts/pruning-checkpoints/rpp-stark/pruning-checkpoints.log

      - name: Upload pruning checkpoint artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pruning-checkpoints
          path: artifacts/pruning-checkpoints

  wallet-state-sync-reconciliation:
    name: Wallet state-sync reconciliation (${{ matrix.backend }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - backend: prover-stwo
            features: prover-stwo
          - backend: rpp-stark
            features: backend-rpp-stark
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: wallet-state-sync-${{ matrix.backend }}
      - name: Run wallet reconciliation test (${{ matrix.backend }})
        env:
          RPP_PROVER_DETERMINISTIC: 1
        run: |
          set -euo pipefail
          mkdir -p "artifacts/wallet-state-sync/${{ matrix.backend }}"
          cargo test --locked --test state_sync_wallet --features "wallet-integration,${{ matrix.features }}" -- --nocapture \
            2>&1 | tee "artifacts/wallet-state-sync/${{ matrix.backend }}/state_sync_wallet.log"
      - name: Upload wallet reconciliation artifacts (${{ matrix.backend }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wallet-state-sync-${{ matrix.backend }}
          path: artifacts/wallet-state-sync/${{ matrix.backend }}

  snapshot-verifier:
    name: Snapshot verifier smoke test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: snapshot-verifier
      - name: Generate snapshot verifier bundle
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          cargo xtask snapshot-verifier
      - name: Upload snapshot verifier artifacts
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-verifier-smoke
          path: target/snapshot-verifier-smoke

  integration-workflows:
    name: Integration workflows (${{ matrix.name }})
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    env:
      MEMPOOL_EVICTION_ARTIFACT_DIR: artifacts/mempool/${{ matrix.name }}/eviction
      MEMPOOL_ORDERING_ARTIFACT_DIR: artifacts/mempool/${{ matrix.name }}/ordering
      MEMPOOL_SPAM_ARTIFACT_DIR: artifacts/mempool/${{ matrix.name }}/spam
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            features: ""
            no_default_features: ""
            experimental: false
          - name: prover-stwo-backend
            features: "prod,prover-stwo"
            no_default_features: "1"
            experimental: false
          - name: prod-stwo-plonky3
            features: "prod,prover-stwo,backend-plonky3"
            no_default_features: "1"
            experimental: false
          - name: mixed-backend-rpp-stark
            features: "backend-rpp-stark"
            no_default_features: ""
            experimental: false
          - name: wallet-gui
            features: "wallet_gui"
            no_default_features: ""
            experimental: false
          - name: wallet-advanced
            features: "wallet_zsi,wallet_hw,wallet_multisig_hooks,wallet_rpc_mtls"
            no_default_features: ""
            experimental: false
      steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.name }}
      - name: Run integration workflows
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          echo "::notice title=Mempool probe artifacts::Artifacts will be written to ${MEMPOOL_SPAM_ARTIFACT_DIR}, ${MEMPOOL_EVICTION_ARTIFACT_DIR}, and ${MEMPOOL_ORDERING_ARTIFACT_DIR} when failures occur"
          if [ -n "${{ matrix.no_default_features }}" ]; then
            export XTASK_NO_DEFAULT_FEATURES="${{ matrix.no_default_features }}"
          fi
          if [ -n "${{ matrix.features }}" ]; then
            export XTASK_FEATURES='${{ matrix.features }}'
          fi
          cargo xtask test-integration
      - name: Snapshot integrity regression (${{ matrix.name }})
        shell: bash
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          args=(test --locked --test root_corruption)
          if [ -n "${{ matrix.no_default_features }}" ]; then
            args+=(--no-default-features)
          fi
          if [ -n "${{ matrix.features }}" ]; then
            args+=(--features "${{ matrix.features }}")
          fi
          RUST_TEST_THREADS=1 cargo "${args[@]}"
      - name: Collect integration artifacts (${{ matrix.name }})
        if: always()
        run: |
          set -euo pipefail
          scripts/ci/collect_test_artifacts.sh "artifacts/integration/${{ matrix.name }}" logs \
            "${MEMPOOL_SPAM_ARTIFACT_DIR}" \
            "${MEMPOOL_EVICTION_ARTIFACT_DIR}" \
            "${MEMPOOL_ORDERING_ARTIFACT_DIR}"
      - name: Upload integration artifacts (${{ matrix.name }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-workflows-${{ matrix.name }}
          path: artifacts/integration/${{ matrix.name }}

  combined-feature-lanes:
    name: Combined storage + pruning (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default-branch256-io-uring
            features: "branch_factor_256,io-uring"
            no_default_features: ""
          - name: backend-rpp-stark-branch256-io-uring
            features: "branch_factor_256,io-uring,backend-rpp-stark"
            no_default_features: ""
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: combined-feature-lane-${{ matrix.name }}
      - name: Run combined coverage lane
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          if [ -n "${{ matrix.no_default_features }}" ]; then
            export XTASK_NO_DEFAULT_FEATURES='${{ matrix.no_default_features }}'
          fi
          if [ -n "${{ matrix.features }}" ]; then
            export XTASK_FEATURES='${{ matrix.features }}'
          fi
          cargo xtask test-combined-lane
      - name: Collect combined lane artifacts (${{ matrix.name }})
        if: always()
        run: |
          set -euo pipefail
          scripts/ci/collect_test_artifacts.sh "artifacts/combined/${{ matrix.name }}" logs
      - name: Upload combined lane artifacts (${{ matrix.name }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: combined-feature-lane-${{ matrix.name }}
          path: artifacts/combined/${{ matrix.name }}

  rpp-stark-cold-start:
    name: RPP-STARK cold start smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rpp-stark-cold-start
      - name: Run cold start health and pipeline smoke
        env:
          RPP_PROCESS_CLUSTER_LOG_ROOT: artifacts/rpp-stark-cold-start
          RPP_PROVER_DETERMINISTIC: 1
          RUST_BACKTRACE: 1
        run: |
          set -euo pipefail
          mkdir -p "${RPP_PROCESS_CLUSTER_LOG_ROOT}"
          cargo build -p firewood --locked --features "branch_factor_256,io-uring"
          cargo test -p rpp-chain --locked --features backend-rpp-stark \
            --test end_to_end_pipeline -- orchestrated_pipeline_finalises_transaction
      - name: Upload cold start artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rpp-stark-cold-start
          path: artifacts/rpp-stark-cold-start

  observability-metrics:
    name: Observability metrics (${{ matrix.name }})
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            features: ""
            no_default_features: ""
            experimental: false
          - name: prover-stwo-backend
            features: "prod,prover-stwo"
            no_default_features: "1"
            experimental: false
          - name: prod-stwo-plonky3
            features: "prod,prover-stwo,backend-plonky3"
            no_default_features: "1"
            experimental: false
          - name: wallet-gui
            features: "wallet_gui"
            no_default_features: ""
            experimental: false
          - name: wallet-advanced
            features: "wallet_zsi,wallet_hw,wallet_multisig_hooks,wallet_rpc_mtls"
            no_default_features: ""
            experimental: false
      steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.name }}
      - name: Run observability metrics
        env:
          FINALITY_ALERT_ARTIFACT_DIR: artifacts/finality-alert-probe/${{ matrix.name }}
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          if [ -n "${{ matrix.no_default_features }}" ]; then
            export XTASK_NO_DEFAULT_FEATURES="${{ matrix.no_default_features }}"
          fi
          if [ -n "${{ matrix.features }}" ]; then
            export XTASK_FEATURES='${{ matrix.features }}'
          fi
          cargo xtask test-observability
          cargo test -p rpp-chain --locked --test finality_alert_probe
      - name: Collect observability artifacts (${{ matrix.name }})
        if: always()
        run: |
          set -euo pipefail
          scripts/ci/collect_test_artifacts.sh \
            "artifacts/observability/${{ matrix.name }}" \
            logs \
            artifacts/finality-alert-probe/${{ matrix.name }}
      - name: Upload observability artifacts (${{ matrix.name }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: observability-metrics-${{ matrix.name }}
          path: artifacts/observability/${{ matrix.name }}

  simnet-smoke:
    name: Simnet smoke (${{ matrix.name }})
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            features: ""
            no_default_features: ""
            experimental: false
          - name: prover-stwo-backend
            features: "prod,prover-stwo"
            no_default_features: "1"
            experimental: false
          - name: prod-stwo-plonky3
            features: "prod,prover-stwo,backend-plonky3"
            no_default_features: "1"
            experimental: false
          - name: wallet-gui
            features: "wallet_gui"
            no_default_features: ""
            experimental: false
          - name: wallet-advanced
            features: "wallet_zsi,wallet_hw,wallet_multisig_hooks,wallet_rpc_mtls"
            no_default_features: ""
            experimental: false
      steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.name }}
      - name: Run simnet scenario
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          if [ -n "${{ matrix.no_default_features }}" ]; then
            export XTASK_NO_DEFAULT_FEATURES="${{ matrix.no_default_features }}"
          fi
          if [ -n "${{ matrix.features }}" ]; then
            export XTASK_FEATURES='${{ matrix.features }}'
          fi
          cargo xtask test-simnet
      - name: Collect simnet artifacts (${{ matrix.name }})
        if: always()
        run: |
          set -euo pipefail
          scripts/ci/collect_test_artifacts.sh "artifacts/simnet-smoke/${{ matrix.name }}" logs target/simnet
      - name: Upload simnet artifacts (${{ matrix.name }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simnet-smoke-${{ matrix.name }}
          path: artifacts/simnet-smoke/${{ matrix.name }}

  wallet-firmware-bundles:
    name: Wallet firmware bundles
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: wallet-firmware
      - name: Build and attest vendor firmware bundles
        run: |
          set -euo pipefail
          cargo xtask wallet-firmware \
            --signing-key deploy/firmware/test_firmware_signing.key \
            --output dist/ci/firmware
      - name: Verify firmware bundle signatures
        run: |
          set -euo pipefail
          shopt -s nullglob
          bundles=(dist/ci/firmware/*/*.tar.gz)
          if [[ ${#bundles[@]} -eq 0 ]]; then
            echo "::error::No firmware bundles produced" >&2
            exit 1
          fi
          for bundle in "${bundles[@]}"; do
            cargo xtask wallet-firmware --verify "$bundle"
          done

  simnet-regression:
    name: Simnet regression sweep
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: simnet-regression
      - name: Run regression harness
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          rm -rf target/simnet/regression-ci
          cargo run -p simnet --bin regression -- \
            --artifacts-root target/simnet/regression-ci
      - name: Upload regression artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simnet-regression
          path: target/simnet/regression-ci

  simnet-canary-rolling:
    name: Canary rolling deploy simulation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: simnet-canary-rolling
      - name: Run canary rolling regression
        run: |
          set -euo pipefail
          export RPP_PROVER_DETERMINISTIC=1
          rm -rf target/simnet/canary-rolling-ci
          cargo run -p simnet --bin regression -- \
            --artifacts-root target/simnet/canary-rolling-ci \
            --scenario tools/simnet/scenarios/canary_rolling_restart.ron
      - name: Upload canary rollout artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simnet-canary-rolling
          path: target/simnet/canary-rolling-ci
