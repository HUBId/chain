groups:
  - name: uptime-baselines
    interval: 1m
    rules:
      - record: uptime:participation_ratio:30d_p50
        expr: quantile_over_time(0.5, uptime_participation_ratio[30d])
        labels:
          component: uptime

      - record: uptime:observation_gap_seconds:30d_p90
        expr: quantile_over_time(0.9, uptime_observation_age_seconds[30d])
        labels:
          component: uptime

      - record: timetoke:epoch_age_seconds:30d_p90
        expr: quantile_over_time(0.9, timetoke_epoch_age_seconds[30d])
        labels:
          component: reputation

      - record: timetoke:accrual_rate_per_second:30d_p50
        expr: quantile_over_time(0.5, rate(timetoke_accrual_hours_total[15m]))
        labels:
          component: reputation

  - name: uptime-reputation
    interval: 30s
    rules:
      - alert: UptimeParticipationDropWarning
        expr: |
          uptime_participation_ratio
            < clamp_min(
                uptime:participation_ratio:30d_p50 - 0.023,
                0.97
              )
        for: 10m
        labels:
          severity: warning
          team: uptime
          sla: uptime
          sla_target: uptime_participation
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Uptime participation dipped below the warning ratio
          description: >-
            Active validator participation fell beneath the documented baseline with buffer for at least ten minutes.
            Correlate with recent node joins/removals and confirm new validators are producing uptime proofs.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: UptimeParticipationDropCritical
        expr: |
          uptime_participation_ratio
            < clamp_min(
                uptime:participation_ratio:30d_p50 - 0.053,
                0.94
              )
        for: 10m
        labels:
          severity: critical
          team: uptime
          sla: uptime
          sla_target: uptime_participation
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Uptime participation breached the critical ratio
          description: >-
            Validator participation in uptime proofs fell below the buffered baseline. Investigate churn, peer counts,
            and scheduler health to restore coverage before timetoke accrual stalls.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: UptimeObservationGapWarning
        expr: |
          max_over_time(uptime_observation_age_seconds[5m])
            > clamp_min(
                uptime:observation_gap_seconds:30d_p90 + 600,
                900
              )
        for: 10m
        labels:
          severity: warning
          team: uptime
          sla: uptime
          sla_target: uptime_observation_gap
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Uptime proofs missing beyond the warning gap
          description: >-
            The latest uptime proof age exceeded the historical baseline plus buffer. Verify schedulers are running after
            node joins and that gossiped observations reach the reputation manager.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: UptimeObservationGapCritical
        expr: |
          max_over_time(uptime_observation_age_seconds[5m])
            > clamp_min(
                uptime:observation_gap_seconds:30d_p90 + 1500,
                1800
              )
        for: 10m
        labels:
          severity: critical
          team: uptime
          sla: uptime
          sla_target: uptime_observation_gap
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Uptime proofs missing beyond the critical gap
          description: >-
            No uptime proofs landed for thirty minutes. Page the on-call to restart schedulers, reseed peers, or remove
            faulty validators before timetoke balances decay.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: TimetokeEpochDelayWarning
        expr: |
          max_over_time(timetoke_epoch_age_seconds[10m])
            > clamp_min(
                timetoke:epoch_age_seconds:30d_p90 + 1800,
                3600
              )
        for: 10m
        labels:
          severity: warning
          team: reputation
          sla: uptime
          sla_target: timetoke_epoch_delay
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Timetoke epoch rollover delayed
          description: >-
            Timetoke epochs have not rolled over within the buffered historical window. Validators may not accrue uptime
            credit; inspect timetoke schedulers and recent proposer elections before the delay widens.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: TimetokeEpochDelayCritical
        expr: |
          max_over_time(timetoke_epoch_age_seconds[10m])
            > clamp_min(
                timetoke:epoch_age_seconds:30d_p90 + 3600,
                5400
              )
        for: 10m
        labels:
          severity: critical
          team: reputation
          sla: uptime
          sla_target: timetoke_epoch_delay
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Timetoke epoch rollover critically delayed
          description: >-
            Timetoke epochs have stalled for more than the buffered baseline. Pause proposer changes and recover the timetoke
            scheduler before resuming normal block production.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: TimetokeAccrualStallWarning
        expr: |
          rate(timetoke_accrual_hours_total[15m])
            < clamp_min(
                timetoke:accrual_rate_per_second:30d_p50 - 0.0003,
                0.00025
              )
        for: 15m
        labels:
          severity: warning
          team: reputation
          sla: uptime
          sla_target: timetoke_accrual_rate
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Timetoke accrual slowed below the warning rate
          description: >-
            Timetoke credit accrual dipped under the buffered historical rate after validator churn. Inspect the uptime scheduler,
            timetoke sync, and recent node removals before balances decay.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts

      - alert: TimetokeAccrualStallCritical
        expr: |
          rate(timetoke_accrual_hours_total[15m])
            < clamp_min(
                timetoke:accrual_rate_per_second:30d_p50 - 0.0003,
                0.00025
              )
        for: 30m
        labels:
          severity: critical
          team: reputation
          sla: uptime
          sla_target: timetoke_accrual_rate
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Timetoke accrual stalled after validator churn
          description: >-
            Timetoke credits stopped increasing for more than thirty minutes. Pause additional removals, restart uptime pipelines,
            and replay missing proofs before the decay cycle slashes healthy operators.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#alerts
