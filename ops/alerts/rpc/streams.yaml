groups:
  - name: rpc-streams
    interval: 30s
    rules:
      - alert: RpcSubscriptionDisconnectLoad
        expr: |
          (min_over_time(rpc_subscription_probe_success_ratio{phase="consensus_load"}[5m]) < 0.98)
            or (increase(rpc_subscription_probe_disconnects_total{phase="consensus_load"}[10m]) > 0)
        for: 10m
        labels:
          severity: warning
          team: rpc
          sla: availability
          environment: "{{ $labels.environment }}"
        annotations:
          summary: RPC subscriptions dropped during consensus load
          description: >-
            RPC subscription probes observed disconnects or missing keep-alives while the consensus load generator
            was active. Inspect gateway timeouts, node logs, and the /wallet/pipeline/stream endpoint before resuming traffic.
          runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#rpc-subscription-probes

      - alert: RpcSubscriptionDisconnectMaintenance
        expr: |
          (min_over_time(rpc_subscription_probe_success_ratio{phase="maintenance"}[10m]) < 0.90)
            or (increase(rpc_subscription_probe_disconnects_total{phase="maintenance"}[15m]) > 1)
        for: 15m
        labels:
          severity: warning
          team: rpc
          sla: availability
          environment: "{{ $labels.environment }}"
        annotations:
          summary: RPC subscription drops persisted after maintenance
          description: >-
            RPC subscription probes are still reporting disconnects or missing keep-alives beyond the maintenance window.
            Confirm traffic drains, restart ordering, and proxy routing so long-running streams stay connected.
          runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#rpc-subscription-probes
