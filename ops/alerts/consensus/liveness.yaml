groups:
  - name: consensus-liveness
    interval: 30s
    rules:
      - record: consensus:block_height_delta:5m
        expr: sum by (environment) (increase(chain_block_height[5m]))
        labels:
          component: consensus

      - record: consensus:block_schedule_slots:5m
        expr: sum by (environment) (increase(consensus_block_schedule_slots_total[5m]))
        labels:
          component: consensus

      - record: consensus:block_production_ratio:5m
        expr: |
          consensus:block_height_delta:5m
            / clamp_min(consensus:block_schedule_slots:5m, 1)
        labels:
          component: consensus

      - record: consensus:missed_slots:5m
        expr: clamp_min(consensus:block_schedule_slots:5m - consensus:block_height_delta:5m, 0)
        labels:
          component: consensus

      - alert: ConsensusLivenessStall
        expr: consensus:block_height_delta:5m <= 0
        for: 10m
        labels:
          severity: critical
          team: consensus
          sla: liveness
          sla_target: block_progress
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Block production stalled for 10 minutes
          description: >-
            Accepted block height has not advanced for ten minutes. Inspect proposer health,
            peer connectivity, and gossip flow before redirecting traffic to healthy nodes.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#consensus-liveness-and-rpc-availability

      - alert: ConsensusBlockProductionLagWarning
        expr: consensus:block_production_ratio:5m < 0.9
        for: 10m
        labels:
          severity: warning
          team: consensus
          sla: liveness
          sla_target: block_production_rate
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Block production rate below 90% of schedule
          description: >-
            Blocks are being produced at less than 90% of the scheduled slot rate for at least ten minutes.
            Investigate proposer rotation, VRF submissions, and peer connectivity before the gap widens.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#block-production-rate-and-slot-budget

      - alert: ConsensusBlockProductionLagCritical
        expr: consensus:block_production_ratio:5m < 0.75
        for: 10m
        labels:
          severity: critical
          team: consensus
          sla: liveness
          sla_target: block_production_rate
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Block production rate below 75% of schedule
          description: >-
            Blocks are being produced at less than 75% of the scheduled slot rate for at least ten minutes. Page the on-call
            and execute the consensus liveness runbook to restore proposer health before finality stalls.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#block-production-rate-and-slot-budget

      - alert: ConsensusMissedSlotsWarning
        expr: consensus:missed_slots:5m > 2
        for: 10m
        labels:
          severity: warning
          team: consensus
          sla: liveness
          sla_target: slot_coverage
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Proposers are missing slots faster than finality can absorb
          description: >-
            The scheduled slot count exceeded produced blocks by more than two slots for at least ten minutes. Inspect per-slot
            prover latency and timetoke replay compliance before the deficit widens into a finality stall.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#missed-slots-under-prover-load

      - alert: ConsensusMissedSlotsCritical
        expr: consensus:missed_slots:5m > 4
        for: 5m
        labels:
          severity: critical
          team: consensus
          sla: liveness
          sla_target: slot_coverage
          environment: "{{ $labels.environment }}"
        annotations:
          summary: Slot misses are compounding and finality is at risk
          description: >-
            Scheduled slots outpace produced blocks by more than four slots for five minutes. Quarantine unhealthy leaders,
            check prover queue latency per slot, and validate timetoke replay health before rotating proposers back in.
        runbook_url: https://github.com/ava-labs/chain/blob/main/docs/operations/uptime.md#missed-slots-under-prover-load
